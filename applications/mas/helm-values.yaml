# mas - bjw-s/app-template values
# Multi-Agent System

defaultPodOptions:
  hostPID: true
serviceAccount:
  create: false
  name: mas
controllers:
  main:
    replicas: 1
    strategy: RollingUpdate
    rollingUpdate:
      unavailable: 0
      surge: 1
    revisionHistoryLimit: 3
    initContainers:
      db-init:
        image:
          repository: zot0213.kro.kr/web-apps/mas
          tag: 7777de55 # Updated by ArgoCD Image Updater
          pullPolicy: Always
        command:
          - sh
          - -c
          - |
            psql "$DATABASE_URL" <<'EOF'
            CREATE TABLE IF NOT EXISTS users (
                "id" UUID PRIMARY KEY,
                "identifier" TEXT NOT NULL UNIQUE,
                "metadata" JSONB NOT NULL,
                "createdAt" TEXT
            );
            CREATE TABLE IF NOT EXISTS threads (
                "id" UUID PRIMARY KEY,
                "createdAt" TEXT,
                "name" TEXT,
                "userId" UUID,
                "userIdentifier" TEXT,
                "tags" TEXT[],
                "metadata" JSONB,
                FOREIGN KEY ("userId") REFERENCES users("id") ON DELETE CASCADE
            );
            CREATE TABLE IF NOT EXISTS steps (
                "id" UUID PRIMARY KEY,
                "name" TEXT NOT NULL,
                "type" TEXT NOT NULL,
                "threadId" UUID NOT NULL,
                "parentId" UUID,
                "streaming" BOOLEAN NOT NULL,
                "waitForAnswer" BOOLEAN,
                "isError" BOOLEAN,
                "metadata" JSONB,
                "tags" TEXT[],
                "input" TEXT,
                "output" TEXT,
                "createdAt" TEXT,
                "start" TEXT,
                "end" TEXT,
                "generation" JSONB,
                "showInput" TEXT,
                "language" TEXT,
                "indent" INT,
                FOREIGN KEY ("threadId") REFERENCES threads("id") ON DELETE CASCADE
            );
            CREATE TABLE IF NOT EXISTS elements (
                "id" UUID PRIMARY KEY,
                "threadId" UUID,
                "type" TEXT,
                "url" TEXT,
                "chainlitKey" TEXT,
                "name" TEXT NOT NULL,
                "display" TEXT,
                "objectKey" TEXT,
                "size" TEXT,
                "page" INT,
                "language" TEXT,
                "forId" UUID,
                "mime" TEXT,
                "props" JSONB,
                FOREIGN KEY ("threadId") REFERENCES threads("id") ON DELETE CASCADE
            );
            CREATE TABLE IF NOT EXISTS feedbacks (
                "id" UUID PRIMARY KEY,
                "forId" UUID NOT NULL,
                "threadId" UUID NOT NULL,
                "value" INT NOT NULL,
                "comment" TEXT,
                FOREIGN KEY ("threadId") REFERENCES threads("id") ON DELETE CASCADE
            );
            EOF
        env:
          DATABASE_URL:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: uri
    containers:
      main:
        image:
          repository: zot0213.kro.kr/web-apps/mas
          tag: 7777de55 # Updated by ArgoCD Image Updater
          pullPolicy: Always
        securityContext:
          privileged: true
        env:
          ANTHROPIC_API_KEY:
            valueFrom:
              secretKeyRef:
                name: mas-api-keys
                key: anthropic-api-key
          DATABASE_URL:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: uri
          CHAINLIT_DATABASE_URL:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: uri
          POSTGRES_HOST:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: host
          POSTGRES_PORT:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: port
          POSTGRES_USER:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: username
          POSTGRES_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: mas-db-app
                key: password
          REDIS_URL: "redis://redis:6379/0"
        # Resource settings (VPA recommended, no CPU limit for stability)
        resources:
          requests:
            cpu: 15m
            memory: 215Mi
          limits:
            memory: 215Mi
        probes:
          startup:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: 8000
              periodSeconds: 10
              failureThreshold: 30
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: 8000
              initialDelaySeconds: 0
              periodSeconds: 10
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: 8000
              initialDelaySeconds: 0
              periodSeconds: 5
    pod:
      # Affinity - Soft Anti-Affinity to spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: mas
                topologyKey: kubernetes.io/hostname
service:
  main:
    controller: main
    ports:
      http:
        port: 8000
ingress:
  main:
    enabled: true
    className: kong
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      traefik.ingress.kubernetes.io/router.middlewares: authelia-authelia-auth@kubernetescrd
    hosts:
      - host: mas0213.kro.kr
        paths:
          - path: /
            service:
              identifier: main
              port: http
      - host: www.mas0213.kro.kr
        paths:
          - path: /
            service:
              identifier: main
              port: http
    tls:
      - secretName: mas-tls
        hosts:
          - mas0213.kro.kr
          - www.mas0213.kro.kr
