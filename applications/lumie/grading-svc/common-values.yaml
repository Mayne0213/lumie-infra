# grading-svc common chart values
# OMR 채점 서비스 (Python FastAPI)

common:
  name: grading-svc
  namespace: lumie-grading

  # Deployment
  deployment:
    enabled: true

  replicaCount: 1

  # Image
  image:
    registry: zot.mayne.kro.kr
    repository: applications/grading-svc
    tag: "e691d72d"
    pullPolicy: Always

  # Container ports
  ports:
    - name: http
      containerPort: 8000
      protocol: TCP

  # Pod-level security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1001
    runAsGroup: 1001
    fsGroup: 1001

  # Container-level security context
  securityContext:
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

  # Environment variables
  env:
    - name: HOST
      value: "0.0.0.0"
    - name: PORT
      value: "8000"
    - name: EXAM_SERVICE_URL
      value: "http://exam-svc.lumie-exam.svc:8080"
    - name: MAX_IMAGES
      value: "200"
    - name: MAX_WORKERS
      value: "16"

  # Resources (ProcessPoolExecutor + OpenCV requires more memory)
  resources:
    requests:
      cpu: 100m
      memory: 2Gi
    limits:
      memory: 2Gi

  # Health checks (FastAPI)
  healthCheck:
    enabled: true
    port: http
    livenessProbe:
      path: /health
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      path: /health
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

  # Service
  service:
    enabled: true
    type: ClusterIP
    port: 8000  # For ingress backend
    ports:
      - name: http
        port: 8000
        targetPort: http
        protocol: TCP

  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "true"
      konghq.com/plugins: lumie-cors,lumie-jwt,lumie-jwt-claims
      # 대용량 이미지 배치 처리를 위한 타임아웃 설정 (밀리초)
      konghq.com/read-timeout: "300000"      # 5분
      konghq.com/write-timeout: "300000"     # 5분
      konghq.com/connect-timeout: "60000"    # 1분
    hosts:
      - host: lumie0213.kro.kr
        paths:
          - path: /api/grading
            pathType: Prefix
    tls: []

  # ServiceMonitor disabled (FastAPI needs custom metrics setup)
  serviceMonitor:
    enabled: false
