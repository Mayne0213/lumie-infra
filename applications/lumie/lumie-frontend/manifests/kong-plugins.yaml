# Cluster-wide CORS Plugin
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: lumie-cors
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "false"
config:
  origins:
    - "https://lumie0213.kro.kr"
    - "https://dev.lumie0213.kro.kr"
    - "http://localhost:3000"
  methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - OPTIONS
  headers:
    - Accept
    - Authorization
    - Content-Type
    - X-Tenant-Slug
    - X-Request-Id
  exposed_headers:
    - X-Request-Id
  credentials: true
  max_age: 3600
plugin: cors
---
# Cluster-wide JWT Plugin
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: lumie-jwt
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "false"
plugin: jwt
config:
  key_claim_name: iss
  claims_to_verify:
    - exp
  header_names:
    - Authorization
---
# Cluster-wide JWT Claims Extraction Plugin
# Extracts JWT claims and sets X-User-Id, X-Tenant-Slug headers
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: lumie-jwt-claims
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "false"
plugin: post-function
config:
  access:
    - |
      local jwt_token = kong.ctx.shared.authenticated_jwt_token
      if jwt_token then
        local parts = {}
        for part in string.gmatch(jwt_token, "[^%.]+") do
          table.insert(parts, part)
        end
        if #parts >= 2 then
          local payload_b64 = parts[2]
          local padding = 4 - (#payload_b64 % 4)
          if padding < 4 then
            payload_b64 = payload_b64 .. string.rep("=", padding)
          end
          payload_b64 = payload_b64:gsub("-", "+"):gsub("_", "/")
          local payload_json = ngx.decode_base64(payload_b64)
          if payload_json then
            local sub = payload_json:match('"sub"%s*:%s*"([^"]+)"')
            local tenant_slug = payload_json:match('"tenant_slug"%s*:%s*"([^"]+)"')
            local tenant_id = payload_json:match('"tenant_id"%s*:%s*(%d+)')
            local role = payload_json:match('"role"%s*:%s*"([^"]+)"')
            if sub then
              kong.service.request.set_header("X-User-Id", sub)
            end
            if tenant_slug then
              kong.service.request.set_header("X-Tenant-Slug", tenant_slug)
            end
            if tenant_id then
              kong.service.request.set_header("X-Tenant-Id", tenant_id)
            end
            if role then
              kong.service.request.set_header("X-User-Role", role)
            end
          end
        end
      end
