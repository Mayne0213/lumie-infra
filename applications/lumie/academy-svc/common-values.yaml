# academy-svc common chart values

common:
  name: academy-svc
  namespace: lumie-academy

  # Deployment
  deployment:
    enabled: true

  replicaCount: 2

  # Image
  image:
    registry: zot.lumie-infra.com
    repository: applications/academy-svc
    tag: "68b5730f"
    pullPolicy: IfNotPresent

  # Multiple container ports
  ports:
    - name: http
      containerPort: 8080
      protocol: TCP
    - name: grpc
      containerPort: 9090
      protocol: TCP

  # Pod-level security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # Container-level security context
  securityContext:
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

  # Environment variables
  env:
    - name: SPRING_PROFILES_ACTIVE
      value: "prod"
    - name: DB_HOST
      value: "lumie-db-rw.lumie-db.svc"
    - name: DB_PORT
      value: "5432"
    - name: DB_NAME
      value: "lumie"
    - name: DB_USERNAME
      valueFrom:
        secretKeyRef:
          name: academy-svc-db-secrets
          key: username
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: academy-svc-db-secrets
          key: password
    - name: RABBITMQ_HOST
      value: "rabbitmq.lumie-event.svc"
    - name: RABBITMQ_PORT
      value: "5672"
    - name: RABBITMQ_USERNAME
      value: "lumie"
    - name: RABBITMQ_PASSWORD
      valueFrom:
        secretKeyRef:
          name: academy-svc-rabbitmq-secrets
          key: RABBITMQ_PASSWORD
    - name: AUTH_SVC_GRPC_HOST
      value: "auth-svc-grpc.lumie-auth.svc"
    - name: TENANT_SVC_GRPC_HOST
      value: "tenant-svc-grpc.lumie-tenant.svc"
    - name: BILLING_SVC_GRPC_HOST
      value: "billing-svc-grpc.lumie-billing.svc"

  # Resources
  resources:
    requests:
      cpu: 30m
      memory: 512Mi
    limits:
      memory: 512Mi

  # Health checks (Spring Boot Actuator)
  healthCheck:
    enabled: true
    port: http
    livenessProbe:
      path: /actuator/health/liveness
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      path: /actuator/health/readiness
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    startupProbe:
      path: /actuator/health
      periodSeconds: 5
      failureThreshold: 30

  # Service (HTTP only, gRPC via separate manifest)
  service:
    enabled: true
    type: ClusterIP
    port: 8080  # For ingress backend
    ports:
      - name: http
        port: 8080
        targetPort: http
        protocol: TCP

  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "true"
      konghq.com/plugins: lumie-cors,lumie-jwt,lumie-jwt-claims
    hosts:
      - host: lumie0213.kro.kr
        paths:
          - path: /api/academy
            pathType: Prefix
    tls: []

  # ServiceMonitor for Prometheus
  serviceMonitor:
    enabled: true
    endpoints:
      - port: http
        interval: 30s
        path: /actuator/prometheus

  # Vault Static Secrets
  vaultStaticSecrets:
    # RabbitMQ credentials
    - name: academy-svc-rabbitmq-vss
      path: platform/rabbitmq
      destination:
        name: academy-svc-rabbitmq-secrets
        transformation:
          templates:
            RABBITMQ_PASSWORD: "{{ .Secrets.RABBITMQ_PASSWORD }}"
    # Database credentials (from Vault storage/postgresql)
    - name: academy-svc-db-vss
      path: storage/postgresql
      destination:
        name: academy-svc-db-secrets
        transformation:
          templates:
            username: "{{ .Secrets.POSTGRES_USER }}"
            password: "{{ .Secrets.POSTGRES_PASSWORD }}"
