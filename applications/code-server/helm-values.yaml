fullnameOverride: code-server

image:
  repository: zot0213.kro.kr/linuxserver/code-server
  tag: 4.108.2
  pullPolicy: Always

# Persistence configuration for workspace data
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 5Gi
  storageClass: local-path
  mountPath: /config

ingress:
  enabled: true
  ingressClassName: kong
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: authelia-authelia-auth@kubernetescrd
  hosts:
    - host: vscode0213.kro.kr
      paths:
        - /
    - host: www.vscode0213.kro.kr
      paths:
        - /
  tls:
    - secretName: code-server-tls
      hosts:
        - vscode0213.kro.kr
        - www.vscode0213.kro.kr

# Service configuration
service:
  type: ClusterIP
  port: 8080

# Resource settings (no CPU limit for stability)
resources:
  requests:
    cpu: 15m
    memory: 302Mi
  limits:
    memory: 302Mi

# Security context
securityContext:
  enabled: true
  fsGroup: 1000
  runAsUser: 1000

# Volume permissions
volumePermissions:
  enabled: true

# Extra arguments for code-server
extraArgs:
  - --auth
  - none

# Extra environment variables
extraVars:
  - name: TZ
    value: "Asia/Seoul"
  - name: PS1
    value: "coder:\\w~ "
  - name: PUID
    value: "1000"
  - name: PGID
    value: "1000"

# Init container to set permissions on /config
extraInitContainers:
  - name: init-chmod-config
    image: zot0213.kro.kr/library/busybox:latest
    imagePullPolicy: IfNotPresent
    command:
      - sh
      - -c
      - |
        chown -R 1000:1000 /config
    securityContext:
      runAsUser: 0
    volumeMounts:
      - name: data
        mountPath: /config

# Health checks
startupProbe:
  enabled: true
  httpGet:
    path: /healthz
    port: 8080
  periodSeconds: 10
  failureThreshold: 30

livenessProbe:
  enabled: true
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10

readinessProbe:
  enabled: true
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 5
