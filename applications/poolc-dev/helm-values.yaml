# PoolC Dev - Integrated Backend + Frontend using components format

common:
  components:
    # ===== BACKEND =====
    - name: poolc-dev-backend
      image:
        registry: zot0213.kro.kr
        repository: web-apps/poolc-backend
        tag: a06f2804
        pullPolicy: Always
      replicaCount: 1
      containerPort: 8080
      service:
        enabled: true
        type: ClusterIP
        port: 80
      ingress:
        enabled: true
        className: traefik
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          traefik.ingress.kubernetes.io/router.middlewares: poolc-dev-poolc-strip-api-prefix@kubernetescrd
        hosts:
          - host: dev.poolc0213.kro.kr
            paths:
              - path: /api
                pathType: Prefix
        tls:
          - secretName: poolc-dev-tls
            hosts:
              - dev.poolc0213.kro.kr
      resources:
        requests:
          cpu: 23m
          memory: 1115Mi
        limits:
          memory: 1115Mi
      healthCheck:
        enabled: true
        path: /v2/api-docs
        startupProbe:
          periodSeconds: 10
          failureThreshold: 30
        livenessProbe:
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 5
      env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: JAVA_OPTS
          value: "-Xmx512m -Xms384m"
        - name: DB_HOST
          value: "poolc-dev-backend-db-rw:5432"
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: poolc-dev-backend-db-app
              key: dbname
        - name: DB_USER_NAME
          valueFrom:
            secretKeyRef:
              name: poolc-dev-backend-db-app
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: poolc-dev-backend-db-app
              key: password
      envFrom:
        - secretRef:
            name: poolc-dev-backend-jwt-secrets
        - secretRef:
            name: poolc-dev-backend-minio-secrets
        - secretRef:
            name: poolc-dev-backend-app-secrets
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
      vaultStaticSecrets:
        - name: jwt-vss
          path: web-apps/jwt
          destination:
            name: poolc-dev-backend-jwt-secrets
            transformation:
              templates:
                PROJECT_NAME_HERE_SECRET_KEY: "{{ .Secrets.JWT_SECRET }}"
                EXPIRE_LENGTH_IN_MILLISECONDS: "3600000"
        - name: poolc-dev-vss
          path: web-apps/poolc-dev
          destination:
            name: poolc-dev-backend-app-secrets
            transformation:
              templates:
                MINIO_BUCKET: "{{ .Secrets.MINIO_BUCKET }}"
                FILE_DIR: "/tmp/"
                EMAIL_ADDRESS: ""
                EMAIL_PASSWORD: ""
                NAVER_BOOK_API_URL: ""
                NAVER_BOOK_CLIENT_ID: ""
                NAVER_BOOK_CLIENT_SECRET: ""
                KUBERNETES_API_KEY: ""
        - name: minio-vss
          path: bootstrap/minio
          destination:
            name: poolc-dev-backend-minio-secrets
            transformation:
              templates:
                MINIO_ENDPOINT: "{{ .Secrets.MINIO_ENDPOINT }}"
                MINIO_ACCESS_KEY: "{{ .Secrets.MINIO_ACCESS_KEY_ID }}"
                MINIO_SECRET_KEY: "{{ .Secrets.MINIO_SECRET_ACCESS_KEY }}"
                MINIO_REGION: "{{ .Secrets.MINIO_REGION }}"
      middleware:
        enabled: true
        name: poolc-strip-api-prefix
        stripPrefix:
          prefixes:
            - /api

    # ===== FRONTEND =====
    - name: poolc-dev-frontend
      image:
        registry: zot0213.kro.kr
        repository: web-apps/poolc-frontend
        tag: ce294314
        pullPolicy: Always
      replicaCount: 1
      containerPort: 80
      service:
        enabled: true
        type: ClusterIP
        port: 80
      ingress:
        enabled: true
        className: traefik
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - host: dev.poolc0213.kro.kr
            paths:
              - path: /
                pathType: Prefix
        tls:
          - secretName: poolc-dev-tls
            hosts:
              - dev.poolc0213.kro.kr
      resources:
        requests:
          cpu: 10m
          memory: 128Mi
        limits:
          memory: 128Mi
      healthCheck:
        enabled: true
        path: /
        startupProbe:
          periodSeconds: 10
          failureThreshold: 30
        livenessProbe:
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 5
      env:
        - name: VITE_API_URL
          value: "https://dev.poolc0213.kro.kr/api"
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname

  # Shared resources (outside components)
  # CNPG Database for backend
  database:
    enabled: true
    instances: 1
    name: PoolcDevDB
    owner: poolc-dev
    storage:
      size: 1Gi
    resources:
      memory: 256Mi
      cpu: 50m
    backup:
      enabled: false
