apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: git-update-values
  namespace: tekton-pipelines
spec:
  description: Update helm values file with new image digest and push to git
  params:
    - name: GIT_REPO_URL
      description: Git repository URL to update (K3S-HOME)
      type: string
      default: "https://github0213.com/Mayne0213/K3S-HOME.git"
    - name: GIT_BRANCH
      description: Git branch to update
      type: string
      default: main
    - name: VALUES_FILE_PATH
      description: Comma-separated paths to helm values files (e.g., web-apps/poolc-dev/helm-values-backend.yaml,web-apps/poolc/helm-values-backend.yaml)
      type: string
    - name: IMAGE_DIGEST
      description: New image digest to set
      type: string
    - name: APP_NAME
      description: Application name for commit message
      type: string
    - name: YQ_PATH
      description: yq path for image tag (e.g., .image.tag or .controllers.main.containers.main.image.tag)
      type: string
      default: ".image.tag"
  workspaces:
    - name: source
      description: Workspace for git operations
  steps:
    - name: update-and-push
      image: zot0213.kro.kr/applications/alpine-git:v2.47.1
      env:
        - name: GIT_USERNAME
          valueFrom:
            secretKeyRef:
              name: forgejo-credentials
              key: username
        - name: GIT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: forgejo-credentials
              key: password
      script: |
        #!/bin/sh
        set -e

        cd $(workspaces.source.path)

        # Configure git
        git config --global user.email "tekton@k3s-home.local"
        git config --global user.name "Tekton CI"
        git config --global credential.helper store

        # Setup credentials
        REPO_URL=$(echo "$(params.GIT_REPO_URL)" | sed "s|https://|https://${GIT_USERNAME}:${GIT_PASSWORD}@|")

        # Clone repository
        echo "Cloning $(params.GIT_REPO_URL)..."
        git clone --depth=1 --branch=$(params.GIT_BRANCH) "$REPO_URL" k3s-home
        cd k3s-home

        # Parse comma-separated file paths
        VALUES_FILES="$(params.VALUES_FILE_PATH)"
        IMAGE_TAG="$(params.IMAGE_DIGEST)"
        YQ_PATH="$(params.YQ_PATH)"

        # Extract the key name from YQ_PATH (e.g., .image.tag -> tag)
        TAG_KEY=$(echo "$YQ_PATH" | sed 's/.*\.//')

        # Process each values file
        echo "$VALUES_FILES" | tr ',' '\n' | while read -r VALUES_FILE; do
          # Skip empty lines
          [ -z "$VALUES_FILE" ] && continue

          echo "Processing: $VALUES_FILE"

          if [ ! -f "$VALUES_FILE" ]; then
            echo "WARNING: Values file not found: $VALUES_FILE, skipping..."
            continue
          fi

          # Update image tag using sed (extract key from YQ_PATH)
          sed -i "s/^\(\s*${TAG_KEY}:\s*\).*/\1${IMAGE_TAG}/" "$VALUES_FILE"

          # Add to staging
          git add "$VALUES_FILE"
          echo "Updated: $VALUES_FILE"
        done

        # Check if there are staged changes
        if git diff --cached --quiet; then
          echo "No changes detected, skipping commit"
          exit 0
        fi

        # Show the changes
        echo "Changes:"
        git diff --cached

        # Commit and push
        git commit -m "CHORE(app): update $(params.APP_NAME) image to $IMAGE_TAG"

        echo "Pushing to $(params.GIT_BRANCH)..."
        git push origin $(params.GIT_BRANCH)

        echo "Successfully updated values files"
