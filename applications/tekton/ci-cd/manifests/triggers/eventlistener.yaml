apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: github-listener
  namespace: tekton-pipelines
spec:
  serviceAccountName: tekton-triggers-sa
  triggers:
    # Next.js apps (main branch)
    - name: github-push-nextjs
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in []"
            - name: "overlays"
              value:
                - key: build_args
                  expression: "''"
      bindings:
        - ref: github-push-binding
        - name: build-args
          value: $(extensions.build_args)
      template:
        ref: nextjs-build-template
    - name: github-push-docusaurus
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['docusaurus']"
      bindings:
        - ref: github-push-binding
      template:
        ref: docusaurus-build-template
    - name: github-push-fastapi
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['joossam']"
      bindings:
        - ref: github-push-binding
      template:
        ref: fastapi-build-template
    - name: github-push-mas
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['mas']"
      bindings:
        - ref: github-push-binding
      template:
        ref: mas-build-template
    # GitHub Lumie triggers
    - name: github-push-lumie-frontend
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-frontend']"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-frontend-build-template
    - name: github-push-lumie-tenant-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/platform/tenant-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/platform/tenant-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-tenant-svc-build-template
    - name: github-push-lumie-billing-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/platform/billing-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/platform/billing-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-billing-svc-build-template
    - name: github-push-lumie-auth-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/platform/auth-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/platform/auth-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-auth-svc-build-template
    - name: github-push-lumie-academy-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/academy-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/core/academy-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-academy-svc-build-template
    - name: github-push-lumie-exam-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/exam-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/core/exam-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-exam-svc-build-template
    - name: github-push-lumie-content-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/content-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/core/content-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-content-svc-build-template
    - name: github-push-lumie-file-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/support/file-svc/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/support/file-svc/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-file-svc-build-template
    - name: github-push-lumie-spreadsheet-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/spreadsheet-svc/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')) || c.modified.exists(f, f.startsWith('services/core/spreadsheet-svc/') || f.startsWith('libs/grpc-api/') || f.startsWith('libs/common/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-spreadsheet-svc-build-template
    # Lumie AI triggers
    - name: github-push-lumie-grading-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-ai'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/grading/')) || c.modified.exists(f, f.startsWith('services/grading/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-grading-svc-build-template
    - name: github-push-lumie-report-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-ai'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/report/')) || c.modified.exists(f, f.startsWith('services/report/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-report-svc-build-template
    - name: github-push-lumie-audio-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-ai'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/audio/')) || c.modified.exists(f, f.startsWith('services/audio/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-audio-svc-build-template
  resources:
    kubernetesResource:
      spec:
        template:
          spec:
            serviceAccountName: tekton-triggers-sa
            containers:
              - resources:
                  requests:
                    memory: "128Mi"
                    cpu: "50m"
                  limits:
                    memory: "128Mi"
