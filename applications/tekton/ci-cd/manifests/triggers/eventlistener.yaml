apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: github-listener
  namespace: tekton-pipelines
spec:
  serviceAccountName: tekton-triggers-sa
  triggers:
    # Next.js apps (main branch)
    - name: github-push-nextjs
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in []"
            - name: "overlays"
              value:
                - key: build_args
                  expression: "''"
      bindings:
        - ref: github-push-binding
        - name: build-args
          value: $(extensions.build_args)
      template:
        ref: nextjs-build-template
    - name: github-push-docusaurus
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['docusaurus']"
      bindings:
        - ref: github-push-binding
      template:
        ref: docusaurus-build-template
    - name: github-push-fastapi
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['joossam']"
      bindings:
        - ref: github-push-binding
      template:
        ref: fastapi-build-template
    - name: github-push-mas
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['mas']"
      bindings:
        - ref: github-push-binding
      template:
        ref: mas-build-template
    - name: github-push-poolc-frontend
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/dev')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['poolc-frontend']"
      bindings:
        - ref: github-push-binding
      template:
        ref: poolc-frontend-build-template
    - name: github-push-poolc-backend
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/dev')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['poolc-backend']"
      bindings:
        - ref: github-push-binding
      template:
        ref: poolc-backend-build-template
    # GitHub Lumie triggers
    - name: github-push-lumie-frontend
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-frontend']"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-frontend-build-template
    - name: github-push-lumie-db-migrations
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('libs/db-migrations/')) || c.modified.exists(f, f.startsWith('libs/db-migrations/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-db-migrations-build-template
    - name: github-push-lumie-tenant-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/platform/tenant-svc/') || f.startsWith('libs/messaging/')) || c.modified.exists(f, f.startsWith('services/platform/tenant-svc/') || f.startsWith('libs/messaging/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-tenant-svc-build-template
    - name: github-push-lumie-billing-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/platform/billing-svc/') || f.startsWith('libs/messaging/')) || c.modified.exists(f, f.startsWith('services/platform/billing-svc/') || f.startsWith('libs/messaging/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-billing-svc-build-template
    - name: github-push-lumie-auth-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/platform/auth-svc/') || f.startsWith('libs/messaging/')) || c.modified.exists(f, f.startsWith('services/platform/auth-svc/') || f.startsWith('libs/messaging/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-auth-svc-build-template
    - name: github-push-lumie-academy-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/academy-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/')) || c.modified.exists(f, f.startsWith('services/core/academy-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-academy-svc-build-template
    - name: github-push-lumie-exam-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/exam-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/')) || c.modified.exists(f, f.startsWith('services/core/exam-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-exam-svc-build-template
    - name: github-push-lumie-content-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-backend'] && body.commits.exists(c, c.added.exists(f, f.startsWith('services/core/content-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/')) || c.modified.exists(f, f.startsWith('services/core/content-svc/') || f.startsWith('libs/messaging/') || f.startsWith('libs/grpc-api/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-content-svc-build-template
    # Lumie AI triggers
    - name: github-push-lumie-grading-svc
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: github-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['lumie-ai'] && body.commits.exists(c, c.added.exists(f, f.startsWith('grading/')) || c.modified.exists(f, f.startsWith('grading/')))"
      bindings:
        - ref: github-push-binding
      template:
        ref: lumie-grading-svc-build-template
  resources:
    kubernetesResource:
      spec:
        template:
          spec:
            serviceAccountName: tekton-triggers-sa
            tolerations:
              - key: "node-role.kubernetes.io/control-plane"
                operator: "Exists"
                effect: "NoSchedule"
            nodeSelector:
              node-role.kubernetes.io/control-plane: "true"
            containers:
              - resources:
                  requests:
                    memory: "128Mi"
                    cpu: "50m"
                  limits:
                    memory: "128Mi"
