apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: forgejo-listener
  namespace: tekton-pipelines
spec:
  serviceAccountName: tekton-triggers-sa
  triggers:
    - name: forgejo-push-nextjs
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['jovies', 'jotion', 'jaejadle', 'portfolio', 'todo']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: nextjs-build-template
    - name: forgejo-push-docusaurus
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['docusaurus']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: docusaurus-build-template
    - name: forgejo-push-fastapi
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['joossam']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: fastapi-build-template
    - name: forgejo-push-mas
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/main')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['mas']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: mas-build-template
    # Develop branch triggers for -dev deployments
    - name: forgejo-push-nextjs-dev
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/develop')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['jaejadle']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: nextjs-dev-build-template
    - name: forgejo-push-fastapi-dev
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/develop')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['joossam']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: fastapi-dev-build-template
    - name: forgejo-push-poolc-frontend
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/dev')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['PoolC-frontend']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: poolc-frontend-build-template
    - name: forgejo-push-poolc-backend
      interceptors:
        - ref:
            name: "github"
          params:
            - name: "secretRef"
              value:
                secretName: forgejo-webhook-secret
                secretKey: webhook-secret
            - name: "eventTypes"
              value: ["push"]
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.ref.startsWith('refs/heads/dev')"
            - name: "overlays"
              value:
                - key: branch_name
                  expression: "body.ref.split('/')[2]"
        - ref:
            name: "cel"
          params:
            - name: "filter"
              value: "body.repository.name in ['PoolC-backend']"
      bindings:
        - ref: forgejo-push-binding
      template:
        ref: poolc-backend-build-template
  resources:
    kubernetesResource:
      spec:
        template:
          spec:
            serviceAccountName: tekton-triggers-sa
            containers:
              - resources:
                  requests:
                    memory: "128Mi"
                    cpu: "50m"
                  limits:
                    memory: "128Mi"
