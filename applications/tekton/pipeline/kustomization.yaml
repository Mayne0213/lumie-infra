apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml

# Override upstream images to use zot registry
images:
- name: ghcr.io/tektoncd/pipeline/controller-10a3e32792f33651396d02b6855a6e36
  newName: zot0213.kro.kr/tekton/pipeline-controller
  newTag: v1.6.0
- name: ghcr.io/tektoncd/pipeline/webhook-d4749e605405422fd87700164e31b2d1
  newName: zot0213.kro.kr/tekton/pipeline-webhook
  newTag: v1.6.0
- name: ghcr.io/tektoncd/pipeline/events-a9042f7efb0cbade2a868a1ee5ddd52c
  newName: zot0213.kro.kr/tekton/pipeline-events
  newTag: v1.6.0
- name: ghcr.io/tektoncd/pipeline/resolvers-ff86b24f130c42b88983d3c13993056d
  newName: zot0213.kro.kr/tekton/pipeline-resolvers
  newTag: v1.6.0

patches:
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
  patch: |-
    - op: replace
      path: /metadata/labels/app.kubernetes.io~1instance
      value: tekton-pipeline
- target:
    version: v1
    kind: Namespace
    name: tekton-pipelines
  patch: |-
    - op: replace
      path: /metadata/labels/pod-security.kubernetes.io~1enforce
      value: privileged
    - op: add
      path: /metadata/labels/pod-security.kubernetes.io~1warn
      value: privileged
# Remove CPU limits and set memory request = limit for stability
- target:
    group: apps
    version: v1
    kind: Deployment
    name: tekton-pipelines-webhook
  patch: |-
    - op: remove
      path: /spec/template/spec/containers/0/resources/limits/cpu
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 500Mi
- target:
    group: apps
    version: v1
    kind: Deployment
    name: tekton-pipelines-remote-resolvers
  patch: |-
    - op: remove
      path: /spec/template/spec/containers/0/resources/limits/cpu
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 4Gi
