# Kong CORS Plugin for Lumie Dev
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: lumie-dev-cors
  namespace: lumie-dev
config:
  origins:
    - "https://dev.lumie0213.kro.kr"
    - "http://localhost:3000"
  methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - OPTIONS
  headers:
    - Accept
    - Authorization
    - Content-Type
    - X-Tenant-Slug
    - X-Request-Id
  exposed_headers:
    - X-Request-Id
  credentials: true
  max_age: 3600
plugin: cors
---
# Kong Consumer for JWT validation
# Represents the auth-svc as the token issuer
apiVersion: configuration.konghq.com/v1
kind: KongConsumer
metadata:
  name: lumie-auth-issuer
  namespace: lumie-dev
  annotations:
    kubernetes.io/ingress.class: kong
username: lumie-auth-svc
credentials:
  - kong-jwt-credential
---
# Kong JWT Plugin for protected routes
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: lumie-dev-jwt
  namespace: lumie-dev
plugin: jwt
config:
  key_claim_name: iss
  claims_to_verify:
    - exp
  header_names:
    - Authorization
---
# Post-function plugin to extract JWT claims to headers
# This runs after JWT validation and sets X-User-Id, X-Tenant-Slug headers
# Uses base64 decoding and simple pattern matching (no external modules)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: lumie-dev-jwt-claims
  namespace: lumie-dev
plugin: post-function
config:
  access:
    - |
      local jwt_token = kong.ctx.shared.authenticated_jwt_token
      if jwt_token then
        local parts = {}
        for part in string.gmatch(jwt_token, "[^%.]+") do
          table.insert(parts, part)
        end
        if #parts >= 2 then
          local payload_b64 = parts[2]
          local padding = 4 - (#payload_b64 % 4)
          if padding < 4 then
            payload_b64 = payload_b64 .. string.rep("=", padding)
          end
          payload_b64 = payload_b64:gsub("-", "+"):gsub("_", "/")
          local payload_json = ngx.decode_base64(payload_b64)
          if payload_json then
            local sub = payload_json:match('"sub"%s*:%s*"([^"]+)"')
            local tenant_slug = payload_json:match('"tenant_slug"%s*:%s*"([^"]+)"')
            local tenant_id = payload_json:match('"tenant_id"%s*:%s*(%d+)')
            local role = payload_json:match('"role"%s*:%s*"([^"]+)"')
            if sub then
              kong.service.request.set_header("X-User-Id", sub)
            end
            if tenant_slug then
              kong.service.request.set_header("X-Tenant-Slug", tenant_slug)
            end
            if tenant_id then
              kong.service.request.set_header("X-Tenant-Id", tenant_id)
            end
            if role then
              kong.service.request.set_header("X-User-Role", role)
            end
          end
        end
      end
