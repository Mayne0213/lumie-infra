# ApplicationSet for all web apps
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: web-apps
  namespace: argocd
spec:
  generators:
    - list:
        elements:
          # Simple apps (single container)
          - name: jaejadle
            namespace: jaejadle
            valuesFile: jaejadle.yaml
          - name: jaejadle-dev
            namespace: jaejadle-dev
            valuesFile: jaejadle-dev.yaml
          - name: jotion
            namespace: jotion
            valuesFile: jotion.yaml
          - name: todo
            namespace: todo
            valuesFile: todo.yaml
          - name: joossam
            namespace: joossam
            valuesFile: joossam.yaml
          - name: joossam-dev
            namespace: joossam-dev
            valuesFile: joossam-dev.yaml
          - name: jovies
            namespace: jovies
            valuesFile: jovies.yaml
          - name: portfolio
            namespace: portfolio
            valuesFile: portfolio.yaml
          # Poolc dev app (frontend/backend split)
          - name: poolc-backend-dev
            namespace: poolc-dev
            valuesFile: poolc-backend-dev.yaml
          - name: poolc-frontend-dev
            namespace: poolc-dev
            valuesFile: poolc-frontend-dev.yaml
  template:
    metadata:
      name: "{{name}}"
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      sources:
        # Helm chart
        - repoURL: https://github0213.com/Mayne0213/K3S-HOME.git
          targetRevision: main
          path: charts/common
          helm:
            valueFiles:
              - $values/web-apps/values/{{valuesFile}}
        # Values reference
        - repoURL: https://github0213.com/Mayne0213/K3S-HOME.git
          targetRevision: main
          ref: values
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{namespace}}"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
        managedNamespaceMetadata:
          labels:
            goldilocks.fairwinds.com/enabled: "true"
            zot-registry: "enabled"
            minio-s3: enabled
      revisionHistoryLimit: 10
