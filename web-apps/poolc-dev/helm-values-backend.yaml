# PoolC Dev Backend (Spring Boot) Helm Values

name: poolc-dev-backend
image:
  registry: zot0213.kro.kr
  repository: web-apps/poolc-backend
  tag: 61c75109
  pullPolicy: Always
replicaCount: 1
containerPort: 8080
service:
  enabled: true
  type: ClusterIP
  port: 80
ingress:
  enabled: true
  className: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: poolc-dev-poolc-strip-api-prefix@kubernetescrd
  hosts:
    - host: dev.poolc0213.kro.kr
      paths:
        - path: /api
          pathType: Prefix
  tls:
    - secretName: poolc-dev-tls
      hosts:
        - dev.poolc0213.kro.kr
resources:
  requests:
    cpu: 50m
    memory: 512Mi
  limits:
    memory: 768Mi
healthCheck:
  enabled: true
  path: /v2/api-docs # Swagger endpoint
  startupProbe:
    periodSeconds: 10
    failureThreshold: 30
  livenessProbe:
    initialDelaySeconds: 0
    periodSeconds: 10
    timeoutSeconds: 5
  readinessProbe:
    initialDelaySeconds: 0
    periodSeconds: 5
    timeoutSeconds: 5
env:
  - name: SPRING_PROFILES_ACTIVE
    value: "prod"
  - name: JAVA_OPTS
    value: "-Xmx512m -Xms384m"
  # Database from CNPG
  - name: DB_HOST
    value: "poolc-dev-db-rw:5432"
  - name: DB_NAME
    valueFrom:
      secretKeyRef:
        name: poolc-dev-db-app
        key: dbname
  - name: DB_USER_NAME
    valueFrom:
      secretKeyRef:
        name: poolc-dev-db-app
        key: username
  - name: DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: poolc-dev-db-app
        key: password
# External Secret for sensitive data (JWT secret, MinIO, etc.)
externalSecret:
  enabled: true
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      data:
        # JWT
        PROJECT_NAME_HERE_SECRET_KEY: "{{ .jwtSecret }}"
        EXPIRE_LENGTH_IN_MILLISECONDS: "3600000"
        # MinIO (S3-compatible storage)
        MINIO_ENDPOINT: "{{ .minioEndpoint }}"
        MINIO_ACCESS_KEY: "{{ .minioAccessKey }}"
        MINIO_SECRET_KEY: "{{ .minioSecretKey }}"
        MINIO_REGION: "{{ .minioRegion }}"
        MINIO_BUCKET: "poolc"
        # Defaults for optional services
        FILE_DIR: "/tmp/"
        EMAIL_ADDRESS: ""
        EMAIL_PASSWORD: ""
        NAVER_BOOK_API_URL: ""
        NAVER_BOOK_CLIENT_ID: ""
        NAVER_BOOK_CLIENT_SECRET: ""
        KUBERNETES_API_KEY: ""
  data:
    # From shared JWT secret
    - secretKey: jwtSecret
      remoteRef:
        key: web-apps/jwt
        property: JWT_SECRET
    # From MinIO secret
    - secretKey: minioEndpoint
      remoteRef:
        key: storage/minio
        property: MINIO_ENDPOINT
    - secretKey: minioAccessKey
      remoteRef:
        key: storage/minio
        property: MINIO_ACCESS_KEY_ID
    - secretKey: minioSecretKey
      remoteRef:
        key: storage/minio
        property: MINIO_SECRET_ACCESS_KEY
    - secretKey: minioRegion
      remoteRef:
        key: storage/minio
        property: MINIO_REGION
envFrom:
  - secretRef:
      name: poolc-dev-backend-secrets
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          topologyKey: kubernetes.io/hostname
# Traefik Middleware for stripping /api prefix
middleware:
  enabled: true
  name: poolc-strip-api-prefix
  stripPrefix:
    prefixes:
      - /api
