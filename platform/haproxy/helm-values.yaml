# HAProxy Helm Chart Values
# TLS termination proxy with certificate management
# Note: Infrastructure services (Grafana, ArgoCD, Vault, etc.) moved to Teleport

# =============================================================================
# DEPLOYMENT KIND - DaemonSet for HA
# =============================================================================
kind: DaemonSet

# =============================================================================
# IMAGE - Docker Hub (bootstrap component - external registry required)
# HAProxy cannot use Zot because HAProxy must be running to access Zot
# =============================================================================
image:
  repository: docker.io/library/haproxy
  tag: 3.0-alpine

# =============================================================================
# DAEMONSET CONFIGURATION
# =============================================================================
daemonset:
  useHostNetwork: true
  useHostPort: true
  hostPorts:
    http: 80
    https: 443

# =============================================================================
# DNS POLICY - Required for hostNetwork
# =============================================================================
dnsPolicy: ClusterFirstWithHostNet

# =============================================================================
# SECURITY CONTEXT
# =============================================================================
securityContext:
  enabled: true
  runAsUser: 0
  runAsGroup: 0
  allowPrivilegeEscalation: true
  capabilities:
    drop:
    - ALL
    add:
    - NET_BIND_SERVICE

# =============================================================================
# RESOURCES
# =============================================================================
resources:
  requests:
    cpu: 25m
    memory: 64Mi
  limits:
    memory: 64Mi

# =============================================================================
# TOLERATIONS - Allow scheduling on control-plane nodes
# =============================================================================
tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# =============================================================================
# INIT CONTAINERS - Prepare TLS certificates
# =============================================================================
initContainers:
  - name: prepare-certs
    image: docker.io/alpine/openssl:latest
    command:
      - /bin/sh
      - -c
      - |
        CERT_COUNT=0

        # Combine cert and key into PEM files for each domain
        for dir in /etc/ssl/source/*/; do
          name=$(basename "$dir")
          if [ -f "$dir/tls.crt" ] && [ -f "$dir/tls.key" ]; then
            cat "$dir/tls.crt" "$dir/tls.key" > "/etc/ssl/certs/$name.pem"
            chmod 600 "/etc/ssl/certs/$name.pem"
            echo "Prepared certificate: $name.pem"
            CERT_COUNT=$((CERT_COUNT + 1))
          fi
        done

        # Create fallback self-signed cert if no certificates found
        if [ $CERT_COUNT -eq 0 ]; then
          echo "No certificates found, creating fallback self-signed cert..."
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /tmp/fallback.key \
            -out /tmp/fallback.crt \
            -subj "/CN=localhost/O=Fallback" || { echo "Failed to generate cert"; exit 1; }
          cat /tmp/fallback.crt /tmp/fallback.key > /etc/ssl/certs/fallback.pem
          chmod 600 /etc/ssl/certs/fallback.pem
          echo "Created fallback certificate"
        fi

        # List prepared certificates
        echo "Certificates prepared:"
        ls -la /etc/ssl/certs/
    volumeMounts:
      - name: ssl-certs
        mountPath: /etc/ssl/certs
      # Source TLS secrets (customer-facing services only)
      # Infrastructure services moved to Teleport
      - name: authelia-tls
        mountPath: /etc/ssl/source/authelia-tls
        readOnly: true
      - name: homer-tls
        mountPath: /etc/ssl/source/homer-tls
        readOnly: true
      - name: zot-tls
        mountPath: /etc/ssl/source/zot-tls
        readOnly: true
      - name: minio-api-tls
        mountPath: /etc/ssl/source/minio-api-tls
        readOnly: true
      - name: lumie-frontend-tls
        mountPath: /etc/ssl/source/lumie-frontend-tls
        readOnly: true
      - name: lumie-dev-tls
        mountPath: /etc/ssl/source/lumie-dev-tls
        readOnly: true
      # umami-tls removed - access via Teleport
      - name: docusaurus-tls
        mountPath: /etc/ssl/source/docusaurus-tls
        readOnly: true
      - name: gitea-tls
        mountPath: /etc/ssl/source/gitea-tls
        readOnly: true
      - name: forgejo-tls
        mountPath: /etc/ssl/source/forgejo-tls
        readOnly: true
      - name: poolc-tls
        mountPath: /etc/ssl/source/poolc-tls
        readOnly: true
      - name: poolc-dev-tls
        mountPath: /etc/ssl/source/poolc-dev-tls
        readOnly: true
      - name: joossam-tls
        mountPath: /etc/ssl/source/joossam-tls
        readOnly: true
      - name: mas-tls
        mountPath: /etc/ssl/source/mas-tls
        readOnly: true

# =============================================================================
# EXTRA VOLUMES - TLS certificates and secrets
# =============================================================================
extraVolumes:
  - name: ssl-certs
    emptyDir: {}
  # TLS secrets for customer-facing services
  # Infrastructure services (grafana, argocd, vault, etc.) moved to Teleport
  - name: authelia-tls
    secret:
      secretName: authelia-tls
      optional: true
  - name: homer-tls
    secret:
      secretName: homer-tls
      optional: true
  - name: zot-tls
    secret:
      secretName: zot-tls
      optional: true
  - name: minio-api-tls
    secret:
      secretName: minio-api-tls
      optional: true
  - name: lumie-frontend-tls
    secret:
      secretName: lumie-frontend-tls
      optional: true
  - name: lumie-dev-tls
    secret:
      secretName: lumie-dev-tls
      optional: true
  # umami-tls removed - access via Teleport
  - name: docusaurus-tls
    secret:
      secretName: docusaurus-tls
      optional: true
  - name: gitea-tls
    secret:
      secretName: gitea-tls
      optional: true
  - name: forgejo-tls
    secret:
      secretName: forgejo-gitea-tls
      optional: true
  - name: poolc-tls
    secret:
      secretName: poolc-tls
      optional: true
  - name: poolc-dev-tls
    secret:
      secretName: poolc-dev-tls
      optional: true
  - name: joossam-tls
    secret:
      secretName: joossam-tls
      optional: true
  - name: mas-tls
    secret:
      secretName: mas-tls
      optional: true

# =============================================================================
# EXTRA VOLUME MOUNTS - Mount SSL certs directory
# =============================================================================
extraVolumeMounts:
  - name: ssl-certs
    mountPath: /etc/ssl/certs
    readOnly: true

# =============================================================================
# HAPROXY CONFIGURATION - TLS termination
# =============================================================================
config: |
  global
      log stdout format raw local0
      maxconn 4096
      # SSL tuning
      ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
      ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
      tune.ssl.default-dh-param 2048

  defaults
      log global
      option httplog
      timeout connect 10s
      timeout client 300s
      timeout server 300s
      timeout http-request 300s
      timeout http-keep-alive 10s

  # HTTP frontend - redirect to HTTPS
  frontend http_front
      bind *:80
      mode http
      # ACME challenge pass-through for cert-manager
      acl is_acme path_beg /.well-known/acme-challenge/
      use_backend kong_http if is_acme
      # Redirect all other HTTP to HTTPS
      redirect scheme https code 301 if !is_acme

  # HTTPS frontend - TLS termination with SNI
  frontend https_front
      bind *:443 ssl crt /etc/ssl/certs/ alpn h2,http/1.1
      mode http
      # Add headers for backend
      http-request set-header X-Forwarded-Proto https
      http-request set-header X-Forwarded-Port 443
      http-request set-header X-Real-IP %[src]
      default_backend kong_http

  # HTTP backend - forward to Kong
  backend kong_http
      mode http
      balance roundrobin
      option forwardfor
      server kong kong-gateway-proxy.kong.svc.cluster.local:80 check

# =============================================================================
# CONTAINER PORTS (must match hostPorts)
# =============================================================================
containerPorts:
  http: 80
  https: 443

# =============================================================================
# SERVICE - Not needed (hostNetwork used)
# =============================================================================
service:
  type: ClusterIP
  additionalPorts: {}
  rawAdditionalPorts: []
  nodePorts: {}

serviceAccount:
  create: true
