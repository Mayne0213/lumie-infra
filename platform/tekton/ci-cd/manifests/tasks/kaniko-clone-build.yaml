apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-clone-build
  namespace: tekton-pipelines
spec:
  description: Clone git repo and build/push container image using Kaniko
  params:
    - name: GIT_URL
      description: Git repository URL
      type: string
    - name: GIT_REVISION
      description: Git revision (branch/tag/sha)
      type: string
      default: main
    - name: IMAGE
      description: Image reference without tag (registry/repo)
      type: string
    - name: TAG
      description: Image tag
      type: string
      default: latest
    - name: CONTEXT
      description: Build context directory relative to repo root
      type: string
      default: .
    - name: DOCKERFILE
      description: Dockerfile path relative to context
      type: string
      default: Dockerfile
    - name: BUILD_ARGS
      description: Docker build arguments (e.g., --build-arg KEY=VALUE)
      type: array
      default: []
  workspaces:
    - name: source
      description: Workspace for git clone and build
    - name: dockerconfig
      description: Docker config for registry auth
      optional: true
  results:
    - name: IMAGE_DIGEST
      description: Digest of built image
    - name: COMMIT_SHA
      description: Git commit SHA
  steps:
    - name: clone
      image: docker.io/alpine/git:latest
      script: |
        #!/bin/sh
        set -e
        cd $(workspaces.source.path)
        git clone --depth=1 --branch=$(params.GIT_REVISION) $(params.GIT_URL) .
        COMMIT=$(git rev-parse HEAD)
        echo -n "$COMMIT" > /tekton/results/COMMIT_SHA
        echo "Cloned $(params.GIT_URL) at $COMMIT"
        ls -la $(params.CONTEXT)/
    - name: setup-docker-config
      image: docker.io/library/alpine:latest
      env:
        - name: IMAGE
          value: $(params.IMAGE)
      script: |
        #!/bin/sh
        set -e
        DOCKER_CONFIG_FILE="$(workspaces.dockerconfig.path)/.dockerconfigjson"
        REGISTRY=$(echo "$IMAGE" | cut -d'/' -f1)

        if [ -f "$DOCKER_CONFIG_FILE" ]; then
          USER=$(sed -n 's/.*"username":"\([^"]*\)".*/\1/p' "$DOCKER_CONFIG_FILE")
          PASS=$(sed -n 's/.*"password":"\([^"]*\)".*/\1/p' "$DOCKER_CONFIG_FILE")
          AUTH=$(echo -n "$USER:$PASS" | base64)

          mkdir -p /kaniko/.docker
          echo "{\"auths\":{\"$REGISTRY\":{\"username\":\"$USER\",\"password\":\"$PASS\",\"auth\":\"$AUTH\"}}}" > /kaniko/.docker/config.json
          echo "Docker config created for $REGISTRY"
        fi
      volumeMounts:
        - name: kaniko-docker
          mountPath: /kaniko/.docker
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:latest
      env:
        - name: DOCKER_CONFIG
          value: /kaniko/.docker
      args:
        - --context=$(workspaces.source.path)/$(params.CONTEXT)
        - --dockerfile=$(workspaces.source.path)/$(params.CONTEXT)/$(params.DOCKERFILE)
        - --destination=$(params.IMAGE):$(params.TAG)
        - --destination=$(params.IMAGE):latest
        - --digest-file=/tekton/results/IMAGE_DIGEST
        - --skip-tls-verify
        - --cache=false
        - --snapshot-mode=redo
        - --use-new-run
        - $(params.BUILD_ARGS[*])
      volumeMounts:
        - name: kaniko-docker
          mountPath: /kaniko/.docker
  volumes:
    - name: kaniko-docker
      emptyDir: {}
