apiVersion: batch/v1
kind: Job
metadata:
  name: annotate-tls-secrets
  namespace: reflector
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: reflector-annotator
      restartPolicy: OnFailure
      containers:
        - name: annotate
          image: bitnami/kubectl:1.31
          command:
            - /bin/bash
            - -c
            - |
              # TLS secrets to annotate for Reflector
              SECRETS=(
                "authelia:authelia-tls"
                "grafana:grafana-tls"
                "goldilocks:goldilocks-dashboard-tls"
                "homer:homer-tls"
                "vault:vault-tls"
                "zot:zot-tls"
                "argocd:argocd-server-tls"
                "headlamp:headlamp-tls"
                "code-server:code-server-tls"
                "minio:minio-api-tls"
                "minio:minio-console-tls"
                "lumie-frontend:lumie-frontend-tls"
                "lumie-dev:lumie-dev-tls"
                "pgweb:pgweb-tls"
                "umami:umami-tls"
                "tekton-pipelines:tekton-dashboard-tls"
                "alertmanager:karma-tls"
                "velero:velero-ui-tls"
                "docusaurus:docusaurus-tls"
                "gitea:gitea-tls"
                "forgejo:gitea-tls"
                "poolc:poolc-tls"
                "poolc-dev:poolc-dev-tls"
                "joossam:joossam-tls"
                "mas:mas-tls"
              )

              for entry in "${SECRETS[@]}"; do
                ns="${entry%%:*}"
                secret="${entry##*:}"
                echo "Annotating $ns/$secret..."
                kubectl annotate secret "$secret" -n "$ns" \
                  reflector.v1.k8s.emberstack.com/reflection-allowed="true" \
                  reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces="haproxy" \
                  --overwrite 2>/dev/null || echo "  Secret $ns/$secret not found, skipping"
              done

              echo "Done annotating TLS secrets"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: reflector-annotator
  namespace: reflector
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: reflector-annotator
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: reflector-annotator
subjects:
  - kind: ServiceAccount
    name: reflector-annotator
    namespace: reflector
roleRef:
  kind: ClusterRole
  name: reflector-annotator
  apiGroup: rbac.authorization.k8s.io
