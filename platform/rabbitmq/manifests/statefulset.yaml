# RabbitMQ StatefulSet for LUMIE Event Bus
# Uses official RabbitMQ image with ARM64 support
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: lumie-event
spec:
  serviceName: rabbitmq-headless
  replicas: 1
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      serviceAccountName: rabbitmq
      securityContext:
        fsGroup: 999
        runAsUser: 999
        runAsGroup: 999
      initContainers:
      - name: setup-erlang-cookie
        image: zot0213.kro.kr/applications/kubectl:1.32
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
        env:
        - name: RABBITMQ_ERLANG_COOKIE
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secrets
              key: rabbitmq-erlang-cookie
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for RabbitMQ secrets..."
          until kubectl get secret rabbitmq-secrets -n lumie-event 2>/dev/null; do
            echo "Secret not ready, waiting..."
            sleep 5
          done
          echo "Setting up Erlang cookie..."
          rm -f /var/lib/rabbitmq/.erlang.cookie
          echo -n "$RABBITMQ_ERLANG_COOKIE" > /var/lib/rabbitmq/.erlang.cookie
          chmod 400 /var/lib/rabbitmq/.erlang.cookie
          echo "Erlang cookie configured!"
        volumeMounts:
        - name: data
          mountPath: /var/lib/rabbitmq
      containers:
      - name: rabbitmq
        image: zot0213.kro.kr/platform/rabbitmq:4.0-management
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
        ports:
        - name: amqp
          containerPort: 5672
        - name: management
          containerPort: 15672
        - name: epmd
          containerPort: 4369
        - name: clustering
          containerPort: 25672
        env:
        - name: RABBITMQ_USE_LONGNAME
          value: "true"
        - name: RABBITMQ_NODENAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_SERVICE_NAME
          value: rabbitmq-headless
        - name: K8S_HOSTNAME_SUFFIX
          value: .rabbitmq-headless.lumie-event.svc.cluster.local
        - name: RABBITMQ_DEFAULT_USER
          value: lumie
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secrets
              key: rabbitmq-password
        volumeMounts:
        - name: data
          mountPath: /var/lib/rabbitmq
        - name: config
          mountPath: /etc/rabbitmq/conf.d/10-custom.conf
          subPath: rabbitmq.conf
        - name: plugins
          mountPath: /etc/rabbitmq/enabled_plugins
          subPath: enabled_plugins
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
        livenessProbe:
          exec:
            command:
            - rabbitmq-diagnostics
            - -q
            - ping
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          exec:
            command:
            - rabbitmq-diagnostics
            - -q
            - check_running
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
      volumes:
      - name: config
        configMap:
          name: rabbitmq-config
      - name: plugins
        configMap:
          name: rabbitmq-config
          items:
          - key: enabled_plugins
            path: enabled_plugins
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: local-path
      resources:
        requests:
          storage: 2Gi
