# RabbitMQ StatefulSet for LUMIE Event Bus
# Uses official RabbitMQ image with ARM64 support
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: lumie-rabbitmq
  namespace: lumie-event
spec:
  serviceName: lumie-rabbitmq-headless
  replicas: 3
  selector:
    matchLabels:
      app: lumie-rabbitmq
  template:
    metadata:
      labels:
        app: lumie-rabbitmq
    spec:
      serviceAccountName: lumie-rabbitmq
      initContainers:
      - name: wait-for-secrets
        image: zot0213.kro.kr/applications/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for RabbitMQ secrets..."
          until kubectl get secret lumie-rabbitmq-secrets -n lumie-event 2>/dev/null; do
            echo "Secret not ready, waiting..."
            sleep 5
          done
          echo "Secrets ready!"
      containers:
      - name: rabbitmq
        image: zot0213.kro.kr/platform/rabbitmq:4.0-management
        ports:
        - name: amqp
          containerPort: 5672
        - name: management
          containerPort: 15672
        - name: epmd
          containerPort: 4369
        - name: clustering
          containerPort: 25672
        env:
        - name: RABBITMQ_USE_LONGNAME
          value: "true"
        - name: RABBITMQ_NODENAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_SERVICE_NAME
          value: lumie-rabbitmq-headless
        - name: K8S_HOSTNAME_SUFFIX
          value: .lumie-rabbitmq-headless.lumie-event.svc.cluster.local
        - name: RABBITMQ_DEFAULT_USER
          value: lumie
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: lumie-rabbitmq-secrets
              key: rabbitmq-password
        - name: RABBITMQ_ERLANG_COOKIE
          valueFrom:
            secretKeyRef:
              name: lumie-rabbitmq-secrets
              key: rabbitmq-erlang-cookie
        volumeMounts:
        - name: data
          mountPath: /var/lib/rabbitmq
        - name: config
          mountPath: /etc/rabbitmq/conf.d/10-custom.conf
          subPath: rabbitmq.conf
        - name: definitions
          mountPath: /etc/rabbitmq/definitions.json
          subPath: definitions.json
        - name: plugins
          mountPath: /etc/rabbitmq/enabled_plugins
          subPath: enabled_plugins
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
        livenessProbe:
          exec:
            command:
            - rabbitmq-diagnostics
            - -q
            - ping
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          exec:
            command:
            - rabbitmq-diagnostics
            - -q
            - check_running
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
      volumes:
      - name: config
        configMap:
          name: lumie-rabbitmq-config
      - name: definitions
        configMap:
          name: lumie-rabbitmq-definitions
      - name: plugins
        configMap:
          name: lumie-rabbitmq-config
          items:
          - key: enabled_plugins
            path: enabled_plugins
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: local-path
      resources:
        requests:
          storage: 2Gi
