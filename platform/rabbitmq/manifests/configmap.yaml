# RabbitMQ Configuration
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lumie-rabbitmq-config
  namespace: lumie-event
data:
  enabled_plugins: |
    [rabbitmq_management,rabbitmq_peer_discovery_k8s,rabbitmq_prometheus].
  rabbitmq.conf: |
    ## Cluster formation settings
    cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
    cluster_formation.k8s.address_type = hostname
    cluster_formation.k8s.service_name = lumie-rabbitmq-headless
    cluster_formation.k8s.hostname_suffix = .lumie-rabbitmq-headless.lumie-event.svc.cluster.local
    cluster_formation.node_cleanup.interval = 30
    cluster_formation.node_cleanup.only_log_warning = true
    cluster_partition_handling = autoheal

    ## Queue settings
    queue_master_locator = min-masters

    ## Memory settings
    vm_memory_high_watermark.relative = 0.7
    vm_memory_high_watermark_paging_ratio = 0.75

    ## Management
    management.load_definitions = /etc/rabbitmq/definitions.json

    ## Logging
    log.console = true
    log.console.level = info
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lumie-rabbitmq-definitions
  namespace: lumie-event
data:
  definitions.json: |
    {
      "vhosts": [
        {"name": "/"}
      ],
      "permissions": [
        {
          "user": "lumie",
          "vhost": "/",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        }
      ],
      "exchanges": [
        {
          "name": "lumie.events",
          "vhost": "/",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "lumie.commands",
          "vhost": "/",
          "type": "direct",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "lumie.dlx",
          "vhost": "/",
          "type": "fanout",
          "durable": true,
          "auto_delete": false
        }
      ],
      "queues": [
        {
          "name": "billing.tenant-created",
          "vhost": "/",
          "durable": true,
          "arguments": {
            "x-dead-letter-exchange": "lumie.dlx"
          }
        },
        {
          "name": "notification.tenant-created",
          "vhost": "/",
          "durable": true,
          "arguments": {
            "x-dead-letter-exchange": "lumie.dlx"
          }
        },
        {
          "name": "notification.course-published",
          "vhost": "/",
          "durable": true,
          "arguments": {
            "x-dead-letter-exchange": "lumie.dlx"
          }
        },
        {
          "name": "notification.assignment-submitted",
          "vhost": "/",
          "durable": true,
          "arguments": {
            "x-dead-letter-exchange": "lumie.dlx"
          }
        },
        {
          "name": "analytics.result-submitted",
          "vhost": "/",
          "durable": true,
          "arguments": {
            "x-dead-letter-exchange": "lumie.dlx"
          }
        },
        {
          "name": "dlq.failed-messages",
          "vhost": "/",
          "durable": true
        }
      ],
      "bindings": [
        {
          "source": "lumie.events",
          "vhost": "/",
          "destination": "billing.tenant-created",
          "destination_type": "queue",
          "routing_key": "tenant.created"
        },
        {
          "source": "lumie.events",
          "vhost": "/",
          "destination": "notification.tenant-created",
          "destination_type": "queue",
          "routing_key": "tenant.created"
        },
        {
          "source": "lumie.events",
          "vhost": "/",
          "destination": "notification.course-published",
          "destination_type": "queue",
          "routing_key": "course.published"
        },
        {
          "source": "lumie.events",
          "vhost": "/",
          "destination": "notification.assignment-submitted",
          "destination_type": "queue",
          "routing_key": "assignment.submitted"
        },
        {
          "source": "lumie.events",
          "vhost": "/",
          "destination": "analytics.result-submitted",
          "destination_type": "queue",
          "routing_key": "result.submitted"
        },
        {
          "source": "lumie.dlx",
          "vhost": "/",
          "destination": "dlq.failed-messages",
          "destination_type": "queue",
          "routing_key": ""
        }
      ]
    }
