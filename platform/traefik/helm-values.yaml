apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # DaemonSet for HA - runs on every node
    deployment:
      kind: DaemonSet

    # Resource limits
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 128Mi

    # Pod Anti-Affinity - 가능하면 각 노드에 분산 배치 (soft)
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: traefik
              topologyKey: kubernetes.io/hostname

    # Cross-namespace middleware 허용
    providers:
      kubernetesCRD:
        allowCrossNamespace: true
      kubernetesIngress:
        ingressEndpoint:
          ip: "10.0.0.55"

    # Service - ClusterIP (HAProxy handles external traffic)
    service:
      type: ClusterIP

    # Ports - PROXY Protocol enabled, no hostPort (HAProxy uses 80/443)
    ports:
      web:
        port: 80
        expose:
          default: true
        proxyProtocol:
          trustedIPs:
            - 10.0.0.0/8
            - 127.0.0.1/32
      websecure:
        port: 443
        expose:
          default: true
        proxyProtocol:
          trustedIPs:
            - 10.0.0.0/8
            - 127.0.0.1/32
      traefik:
        expose:
          default: true

    # Access logs for debugging
    logs:
      access:
        enabled: true
        format: json
        fields:
          headers:
            defaultMode: keep
            names:
              X-Forwarded-For: keep
              X-Real-IP: keep
              User-Agent: keep

    # Prometheus metrics
    metrics:
      prometheus:
        entryPoint: metrics
        addEntryPointsLabels: true
        addRoutersLabels: true
        addServicesLabels: true
        service:
          enabled: true
        serviceMonitor:
          enabled: true
          namespace: prometheus
          additionalLabels:
            release: prometheus
