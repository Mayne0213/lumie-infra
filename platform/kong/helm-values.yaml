# Kong Ingress Controller Configuration
# TLS termination + API Gateway (HAProxy removed)

# Gateway (Kong Proxy) - uses kong/kong subchart
gateway:
  enabled: true

  image:
    repository: kong  # Bootstrap exception: external registry (Kong sits in front of Zot)
    tag: "3.6"

  # DaemonSet + hostNetwork (replaces HAProxy)
  deployment:
    daemonset: true
    hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet

  # Security context for binding ports 80/443
  containerSecurityContext:
    runAsNonRoot: false
    runAsUser: 0
    runAsGroup: 0
    readOnlyRootFilesystem: false
    allowPrivilegeEscalation: true
    seccompProfile:
      type: RuntimeDefault
    capabilities:
      drop:
      - ALL
      add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE

  # Run on control-plane nodes as well
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

  env:
    database: "off"
    nginx_worker_processes: "2"
    proxy_access_log: "/dev/stdout"
    admin_access_log: "/dev/stdout"
    proxy_error_log: "/dev/stderr"
    admin_error_log: "/dev/stderr"
    # hostNetwork: direct client IP without proxy
    trusted_ips: "0.0.0.0/0,::/0"
    real_ip_header: "X-Real-IP"
    real_ip_recursive: "on"
    # Large file upload support (container registry, etc.)
    nginx_proxy_client_max_body_size: "0"
    nginx_proxy_client_body_buffer_size: "8m"

  proxy:
    enabled: true
    type: ClusterIP
    http:
      enabled: true
      containerPort: 80
      servicePort: 80
    tls:
      enabled: true
      containerPort: 443
      servicePort: 443
      parameters:
      - http2

  admin:
    enabled: true
    type: ClusterIP
    clusterIP: None
    http:
      enabled: true
      containerPort: 8001
      servicePort: 8001

  resources:
    requests:
      cpu: 50m
      memory: 1024Mi
    limits:
      memory: 1024Mi

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8100"

# Controller (Kong Ingress Controller) - uses kong-ingress-controller subchart
controller:
  enabled: true

  ingressController:
    enabled: true
    image:
      repository: kong/kubernetes-ingress-controller
      tag: "3.4.10"

    gatewayDiscovery:
      enabled: true
      generateAdminApiService: true

  resources:
    requests:
      cpu: 25m
      memory: 128Mi
    limits:
      memory: 256Mi

# Disable test deployment
deployment:
  test:
    enabled: false
