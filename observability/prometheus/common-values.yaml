# Common chart values for prometheus
common:
  name: prometheus

  # Disable deployment (external chart creates it)
  deployment:
    enabled: false

  service:
    enabled: false

  ingress:
    enabled: false

  # Vault Static Secrets (VSO)
  vaultStaticSecrets:
    # PostgreSQL password for postgres-exporter
    - name: postgresql-vss
      path: storage/postgresql
      destination:
        name: postgresql-password
        transformation:
          templates:
            password: "{{ .Secrets.POSTGRES_PASSWORD }}"

    # Thanos object store credentials
    - name: minio-vss
      path: bootstrap/minio
      destination:
        name: thanos-objstore-secret
        transformation:
          templates:
            objstore.yml: |
              type: S3
              config:
                bucket: thanos
                endpoint: minio.minio.svc.cluster.local:9000
                access_key: {{ .Secrets.MINIO_ROOT_USER }}
                secret_key: {{ .Secrets.MINIO_ROOT_PASSWORD }}
                insecure: true

    # Zot registry credentials for image pull
    - name: zot-vss
      path: bootstrap/zot
      destination:
        name: zot-registry-credentials
        type: kubernetes.io/dockerconfigjson
        transformation:
          templates:
            .dockerconfigjson: '{"auths":{"zot0213.kro.kr":{"username":"{{ .Secrets.ZOT_USERNAME }}","password":"{{ .Secrets.ZOT_PASSWORD }}","auth":"{{ printf "%s:%s" .Secrets.ZOT_USERNAME .Secrets.ZOT_PASSWORD | base64Encode }}"}}}'

  # ServiceMonitor for alertmanager (cross-namespace monitoring)
  serviceMonitor:
    enabled: true
    name: alertmanager
    labels:
      release: prometheus
    namespaceSelector:
      matchNames:
        - alertmanager
    selector:
      matchLabels:
        app.kubernetes.io/instance: alertmanager
        app.kubernetes.io/name: alertmanager
    endpoints:
      - port: http
        path: /metrics
        scheme: http
        interval: 60s
        relabelings:
          - targetLabel: cluster
            replacement: "mayne-cluster"
          - sourceLabels: [__meta_kubernetes_service_name]
            regex: alertmanager-headless
            action: drop

  # PrometheusRules for OOM alerts
  prometheusRules:
    enabled: true
    groups:
      - name: oom.rules
        rules:
          - alert: KubeContainerOOMKilled
            annotations:
              description: "Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} was OOMKilled in the last 10 minutes."
              summary: "Container was recently OOMKilled"
            expr: |
              (
                increase(kube_pod_container_status_restarts_total[10m]) > 0
              )
              and on (namespace, pod, container)
              (
                kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
              )
            for: 0m
            labels:
              severity: warning
