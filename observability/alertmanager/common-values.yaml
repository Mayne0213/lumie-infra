# Common chart values for alertmanager

name: alertmanager

# Disable deployment (external chart creates it)
deployment:
  enabled: false

service:
  enabled: false

ingress:
  enabled: false

# Health check ingress for karma
additionalIngresses:
  - name: health
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      traefik.ingress.kubernetes.io/router.priority: "100"
    className: traefik
    hosts:
      - host: karma0213.kro.kr
        paths:
          - path: /health
            pathType: Exact
    tls:
      - secretName: karma-tls
        hosts:
          - karma0213.kro.kr
    serviceName: karma
    servicePort: 8080

# External Secrets
additionalExternalSecrets:
  # SMTP credentials
  - name: alertmanager-smtp
    refreshInterval: 1h
    secretStoreRef:
      name: vault-backend
      kind: ClusterSecretStore
    target:
      name: alertmanager-smtp
      creationPolicy: Owner
    data:
      - secretKey: smtp_auth_password
        remoteRef:
          key: observability/alertmanager
          property: SMTP_PASSWORD

  # Alertmanager configuration
  - name: alertmanager-config
    refreshInterval: 1h
    secretStoreRef:
      name: vault-backend
      kind: ClusterSecretStore
    target:
      name: alertmanager-config
      creationPolicy: Owner
      template:
        engineVersion: v2
        data:
          alertmanager.yml: |
            global:
              resolve_timeout: 5m
              smtp_smarthost: "smtp.mail.me.com:587"
              smtp_from: "bluemayne0213@icloud.com"
              smtp_auth_username: "bluemayne0213@icloud.com"
              smtp_auth_password: "{{ .smtp_password }}"
              smtp_require_tls: true
            route:
              group_by: ["alertname", "cluster", "service"]
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 4h
              receiver: "email"
              routes:
              - match:
                  alertname: Watchdog
                receiver: "null"
              - match:
                  alertname: InfoInhibitor
                receiver: "null"
              - match:
                  severity: critical
                receiver: "email"
                group_wait: 10s
                repeat_interval: 1h
              - match:
                  severity: warning
                receiver: "email"
                group_wait: 1m
                repeat_interval: 4h
            receivers:
            - name: "email"
              email_configs:
              - to: "bluemayne0213@icloud.com"
                send_resolved: true
                headers:
                  subject: "[{{ "{{" }} .Status | toUpper {{ "}}" }}] {{ "{{" }} .CommonLabels.alertname {{ "}}" }}"
            - name: "null"
            inhibit_rules:
            - source_match:
                severity: "critical"
              target_match:
                severity: "warning"
              equal: ["alertname", "cluster", "service"]
    data:
      - secretKey: smtp_password
        remoteRef:
          key: observability/alertmanager
          property: SMTP_PASSWORD
