# Thanos Helm Values
# Chart: https://github.com/bitnami/charts/tree/main/bitnami/thanos
#
# Architecture:
# - Prometheus (prometheus namespace) + Sidecar â†’ uploads to MinIO
# - Query: queries Sidecar + Store Gateway, deduplicates data
# - Store Gateway: reads historical data from MinIO
# - Compactor: compacts and downsamples data in MinIO

# Allow non-Bitnami images (quay.io/thanos/thanos)
global:
  security:
    allowInsecureImages: true

# Use quay.io image to avoid Docker Hub rate limits
image:
  registry: quay.io
  repository: thanos/thanos
  tag: v0.37.2

# Object storage configuration (MinIO S3)
# Uses secret created by ExternalSecret
existingObjstoreSecret: thanos-objstore-secret

# =============================================================================
# Query - Main query endpoint (Grafana connects here)
# =============================================================================
query:
  enabled: true
  replicaCount: 1

  # Medium priority for observability
  priorityClassName: medium-priority

  # Deduplicate metrics from multiple Prometheus replicas
  dnsDiscovery:
    enabled: true
    sidecarsService: prometheus-kube-prometheus-thanos-discovery
    sidecarsNamespace: prometheus

  # Store endpoints - chart automatically adds storegateway
  # No need to specify manually

  # Deduplication settings
  extraFlags:
    - --query.replica-label=prometheus_replica
    - --query.auto-downsampling

  # Resource settings (no CPU limit for stability)
  resources:
    requests:
      cpu: 15m
      memory: 100Mi
    limits:
      memory: 126Mi

# =============================================================================
# Query Frontend - Caching layer for Query (optional, disabled for small cluster)
# =============================================================================
queryFrontend:
  enabled: false

# =============================================================================
# Store Gateway - Reads historical data from S3 (DISABLED - using local storage only)
# =============================================================================
storegateway:
  enabled: false

# =============================================================================
# Compactor - Compacts and downsamples data in S3 (DISABLED - using local storage only)
# =============================================================================
compactor:
  enabled: false

# =============================================================================
# Ruler - Alerting rules evaluation (disabled, using Prometheus rules)
# =============================================================================
ruler:
  enabled: false

# =============================================================================
# Receive - Remote write endpoint (disabled, using Sidecar)
# =============================================================================
receive:
  enabled: false

# =============================================================================
# Sidecar - Disabled here, enabled in Prometheus helm-values
# =============================================================================
# The sidecar is deployed alongside Prometheus via kube-prometheus-stack

# =============================================================================
# Metrics
# =============================================================================
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: thanos
    labels:
      release: prometheus
