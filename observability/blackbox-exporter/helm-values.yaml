# Prometheus Blackbox Exporter Helm Values
# Chart: https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-blackbox-exporter

# Image configuration - use zot registry
image:
  registry: zot.lumie-infra.com
  repository: prometheus/blackbox-exporter
  tag: "v0.25.0"

fullnameOverride: blackbox-exporter

replicas: 1

# Resource settings (no CPU limit for stability)
resources:
  requests:
    cpu: 15m
    memory: 100Mi
  limits:
    memory: 100Mi

config:
  modules:
    http_2xx:
      prober: http
      timeout: 10s
      http:
        valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
        valid_status_codes: [200, 301, 302, 303]
        method: GET
        follow_redirects: true
        preferred_ip_protocol: ip4
        tls_config:
          insecure_skip_verify: false
    http_2xx_insecure:
      prober: http
      timeout: 10s
      http:
        valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
        valid_status_codes: [200, 301, 302, 303]
        method: GET
        follow_redirects: true
        preferred_ip_protocol: ip4
        tls_config:
          insecure_skip_verify: true
    http_auth_ok:
      prober: http
      timeout: 10s
      http:
        valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
        valid_status_codes: [200, 301, 302, 303, 401]
        method: GET
        follow_redirects: false
        preferred_ip_protocol: ip4
        tls_config:
          insecure_skip_verify: false
    tcp_connect:
      prober: tcp
      timeout: 5s
    icmp:
      prober: icmp
      timeout: 5s
      icmp:
        preferred_ip_protocol: ip4

serviceMonitor:
  enabled: true
  defaults:
    additionalMetricsRelabels: {}
    interval: 60s
    scrapeTimeout: 30s
    module: http_2xx
  additionalLabels:
    release: prometheus
  targets:
    # User Applications
    - name: joossameng
      url: https://joossameng.com
      module: http_2xx
    - name: lumie
      url: https://lumie0213.kro.kr
      module: http_2xx
    - name: lumie-infra
      url: https://lumie-infra.com
      module: http_2xx
    - name: jaejadle
      url: https://disciples-church.com
      module: http_2xx
    - name: joossam-omr
      url: https://joossameng.kro.kr
      module: http_2xx

prometheusRule:
  enabled: true
  additionalLabels:
    release: prometheus
  rules:
    - alert: BlackboxProbeFailed
      expr: probe_success == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Blackbox probe failed for {{ $labels.target }}"
        description: "Probe {{ $labels.instance }} has been failing for more than 5 minutes."
    - alert: BlackboxSlowProbe
      expr: avg_over_time(probe_duration_seconds[5m]) > 5
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Blackbox slow probe for {{ $labels.target }}"
        description: "Probe {{ $labels.instance }} took more than 5s to complete."
    - alert: BlackboxSslCertificateWillExpireSoon
      expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "SSL certificate will expire soon for {{ $labels.target }}"
        description: "SSL certificate expires in {{ $value | humanizeDuration }} for {{ $labels.instance }}."
    - alert: BlackboxSslCertificateExpired
      expr: (probe_ssl_earliest_cert_expiry - time()) <= 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "SSL certificate has expired for {{ $labels.target }}"
        description: "SSL certificate has expired for {{ $labels.instance }}."

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - prometheus-blackbox-exporter
          topologyKey: kubernetes.io/hostname
