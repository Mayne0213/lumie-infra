apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: infra-db
spec:
  instances: 2
  imageName: zot.lumie-infra.com/storage/postgresql-wal2json:18.1

  bootstrap:
    initdb:
      database: teleport
      owner: bluemayne
      secret:
        name: infra-db-bootstrap-secret
      postInitSQL:
        - "ALTER USER bluemayne REPLICATION"
        - "CREATE USER grafana WITH PASSWORD 'VAULT_PASSWORD'"
        - "CREATE DATABASE grafana OWNER grafana"
        - "CREATE USER umami WITH PASSWORD 'VAULT_PASSWORD'"
        - "CREATE DATABASE umami OWNER umami"
        - "CREATE USER keycloak WITH PASSWORD 'VAULT_PASSWORD'"
        - "CREATE DATABASE keycloak OWNER keycloak"

  storage:
    storageClass: local-path
    size: 2Gi

  resources:
    requests:
      memory: "512Mi"
      cpu: "50m"
    limits:
      memory: "512Mi"

  enableSuperuserAccess: true

  postgresql:
    parameters:
      wal_level: "logical"
      max_replication_slots: "4"

  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: required

  monitoring:
    enablePodMonitor: true
