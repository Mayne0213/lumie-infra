apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: velero
data:
  backup.sh: |
    #!/bin/sh
    set -e

    # Variables
    BACKUP_DATE=$(date +%Y%m%d-%H%M%S)
    MINIO_HOST="minio.minio.svc.cluster.local:9000"
    BUCKET="backup"

    echo "=== Starting backup at ${BACKUP_DATE} ==="

    # Configure MinIO client
    echo "Configuring MinIO client..."
    mc alias set minio http://${MINIO_HOST} ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}

    # Check and create bucket if not exists
    echo "Checking backup bucket..."
    if ! mc ls minio/${BUCKET} > /dev/null 2>&1; then
      echo "Creating backup bucket..."
      mc mb minio/${BUCKET}
    fi

    # 1. PostgreSQL backup
    echo "=== PostgreSQL backup ==="
    PG_POD=$(kubectl get pods -n postgresql -l cnpg.io/cluster=postgresql -o jsonpath='{.items[0].metadata.name}')
    echo "Using PostgreSQL pod: ${PG_POD}"

    kubectl exec -n postgresql ${PG_POD} -c postgres -- pg_dumpall -U postgres | gzip > /tmp/postgresql-${BACKUP_DATE}.sql.gz

    echo "Uploading PostgreSQL backup to MinIO..."
    mc cp /tmp/postgresql-${BACKUP_DATE}.sql.gz minio/${BUCKET}/postgresql/
    rm -f /tmp/postgresql-${BACKUP_DATE}.sql.gz
    echo "PostgreSQL backup completed"

    # 2. Gitea SQLite backup
    echo "=== Gitea SQLite backup ==="
    GITEA_POD=$(kubectl get pods -n gitea -l app.kubernetes.io/name=gitea -o jsonpath='{.items[0].metadata.name}')
    echo "Using Gitea pod: ${GITEA_POD}"

    kubectl exec -n gitea ${GITEA_POD} -c gitea -- tar czf - /data/gitea/gitea.db /data/gitea/gitea.db-shm /data/gitea/gitea.db-wal 2>/dev/null > /tmp/gitea-sqlite-${BACKUP_DATE}.tar.gz

    echo "Uploading Gitea SQLite backup to MinIO..."
    mc cp /tmp/gitea-sqlite-${BACKUP_DATE}.tar.gz minio/${BUCKET}/gitea/
    rm -f /tmp/gitea-sqlite-${BACKUP_DATE}.tar.gz
    echo "Gitea SQLite backup completed"

    # 3. Gitea Git repositories backup
    echo "=== Gitea Git repositories backup ==="
    kubectl exec -n gitea ${GITEA_POD} -c gitea -- tar czf - /data/git 2>/dev/null > /tmp/gitea-repos-${BACKUP_DATE}.tar.gz

    echo "Uploading Gitea repositories backup to MinIO..."
    mc cp /tmp/gitea-repos-${BACKUP_DATE}.tar.gz minio/${BUCKET}/gitea/
    rm -f /tmp/gitea-repos-${BACKUP_DATE}.tar.gz
    echo "Gitea repositories backup completed"

    # Cleanup old backups (keep last 7 days)
    echo "=== Cleaning up old backups ==="
    # BusyBox compatible: calculate 7 days ago using epoch seconds
    CUTOFF_DATE=$(date -d "@$(($(date +%s) - 7*86400))" +%Y%m%d)

    for prefix in postgresql gitea; do
      mc ls minio/${BUCKET}/${prefix}/ 2>/dev/null | while read line; do
        filename=$(echo "$line" | awk '{print $NF}')
        # Extract date from filename (format: name-YYYYMMDD-HHMMSS.ext)
        file_date=$(echo "$filename" | grep -oE '[0-9]{8}' | head -1)
        if [ -n "$file_date" ] && [ "$file_date" -lt "$CUTOFF_DATE" ] 2>/dev/null; then
          echo "Removing old backup: ${prefix}/${filename}"
          mc rm minio/${BUCKET}/${prefix}/${filename}
        fi
      done
    done

    echo "=== Backup completed successfully at $(date) ==="
