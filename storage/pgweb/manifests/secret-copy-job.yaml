# Job to copy lumie-db-app secret from lumie-db namespace to pgweb namespace
apiVersion: batch/v1
kind: Job
metadata:
  name: pgweb-secret-sync
  namespace: pgweb
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: pgweb-secret-sync
      restartPolicy: OnFailure
      containers:
      - name: sync
        image: zot0213.kro.kr/bitnami/kubectl:1.32
        command:
        - /bin/sh
        - -c
        - |
          # Get secret from lumie-db namespace and create in pgweb namespace
          kubectl get secret lumie-db-app -n lumie-db -o json | \
            jq 'del(.metadata.resourceVersion, .metadata.uid, .metadata.creationTimestamp, .metadata.ownerReferences) | .metadata.namespace = "pgweb"' | \
            kubectl apply -f -
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pgweb-secret-sync
  namespace: pgweb
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pgweb-secret-sync
  namespace: pgweb
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pgweb-secret-sync
  namespace: pgweb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pgweb-secret-sync
subjects:
- kind: ServiceAccount
  name: pgweb-secret-sync
  namespace: pgweb
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pgweb-secret-reader
  namespace: lumie-db
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["lumie-db-app"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pgweb-secret-reader
  namespace: lumie-db
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pgweb-secret-reader
subjects:
- kind: ServiceAccount
  name: pgweb-secret-sync
  namespace: pgweb
