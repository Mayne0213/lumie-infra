# PgBouncer configuration for multi-tenancy support
# Using session mode to maintain search_path across transactions

replicaCount: 1

image:
  registry: zot0213.kro.kr
  repository: icoretech/pgbouncer-docker
  tag: "1.25.1"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 5432

config:
  # Use Vault-synced secret for admin (from secret/storage/postgresql via VSO)
  existingAdminSecret: lumie-dev-db-secrets
  adminUserKey: username
  adminPasswordKey: password

  # Auth delegation to PostgreSQL using auth_query
  authUser: bluemayne
  authPassword: ""  # Will use existingAdminSecret

  databases:
    lumie:
      host: lumie-dev-db-rw.lumie-dev.svc.cluster.local
      port: 5432
      dbname: lumie

  pgbouncer:
    pool_mode: session
    max_client_conn: 100
    default_pool_size: 20
    min_pool_size: 5
    reserve_pool_size: 5
    # Auth delegation to PostgreSQL
    auth_type: scram-sha-256
    auth_query: SELECT usename, passwd FROM pg_shadow WHERE usename=$1
    # server_reset_query removed - session mode maintains search_path
    # server_reset_query_always removed - not needed for multi-tenancy
    ignore_startup_parameters: extra_float_digits

resources:
  requests:
    cpu: 10m
    memory: 64Mi
  limits:
    memory: 64Mi

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 70
  runAsGroup: 70
