# MinIO Helm Values
# Chart: https://github.com/minio/minio/tree/master/helm/minio
# Mode: Distributed with Erasure Coding (4 drives total)
#
# Disk allocation (1 x 50GB per worker):
# - k3s-worker-1: /mnt/minio-data (0214 account)
# - k3s-worker-2: /mnt/minio-data (0214 account)
# - k3s-worker-3: /mnt/minio-data (0213 account)
# - k3s-worker-4: /mnt/minio-data (0213 account)
# Total: 4 drives for erasure coding (EC:2)

# MinIO image (external registry - switch to zot after recovery)
image:
  repository: quay.io/minio/minio
  tag: RELEASE.2025-01-20T14-49-07Z
  pullPolicy: IfNotPresent

# 4 replicas, 1 drive per replica = 4 drives total
replicas: 4

# Number of drives per node (each pod uses 1 drive)
drivesPerNode: 1

# Persistence - using dedicated 50GB disks
persistence:
  enabled: true
  size: 45Gi
  storageClass: minio-local

# Root credentials from SealedSecret
# Secret contains: root-user and root-password keys
existingSecret: minio-root-password
rootUserSecretKey: root-user
rootPasswordSecretKey: root-password

# Resource settings (VPA recommended, no CPU limit for stability)
resources:
  requests:
    cpu: 63m
    memory: 194Mi
  limits:
    memory: 194Mi

# Service
service:
  type: ClusterIP
  port: 9000

# Console service disabled - using custom console-deployment.yaml instead
consoleService:
  enabled: false

# Environment variables
environment:
  MINIO_API_CORS_ALLOW_ORIGIN: "*"
  MINIO_BROWSER_REDIRECT_URL: "https://minio.minio0213.kro.kr"
  # CPU optimization - disable unused workers
  MINIO_API_REPLICATION_MAX_WORKERS: "1"
  MINIO_API_REPLICATION_MAX_LRG_WORKERS: "1"
  MINIO_API_TRANSITION_WORKERS: "1"
  MINIO_SCANNER_SPEED: "slowest"
  # Limit Go runtime CPU usage
  GOMAXPROCS: "1"

# API Ingress (S3 endpoint)
ingress:
  enabled: true
  ingressClassName: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - s3.minio0213.kro.kr
  tls:
    - secretName: minio-api-tls
      hosts:
        - s3.minio0213.kro.kr

# Console Ingress disabled (using custom console-deployment in manifests/)
consoleIngress:
  enabled: false

# Disable Kubernetes service links to prevent MINIO_SERVICE_PORT conflict
# This prevents Kubernetes from injecting service-related environment variables
enableServiceLinks: false

# Pod annotations for Velero backup exclusion
# Exclude PVC data from backup (prevent circular backup of velero-backups bucket)
# MinIO resources (StatefulSet, Service, etc.) will still be backed up
podAnnotations:
  backup.velero.io/backup-volumes-excludes: export

# Hard anti-affinity - each pod on different node
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - minio
        topologyKey: kubernetes.io/hostname

# High priority for critical storage infrastructure
priorityClassName: high-priority

# Prometheus metrics
metrics:
  serviceMonitor:
    enabled: true
    includeNode: true
    additionalLabels:
      release: prometheus
    interval: 30s
    scrapeTimeout: 10s

# Disable post-install job by setting all triggers to empty
# Job is created if any of: buckets, users, policies, customCommands, svcaccts exist
buckets: []
users: []
policies: []
customCommands: []
svcaccts: []
