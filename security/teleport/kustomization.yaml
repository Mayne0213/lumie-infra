apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
  - name: teleport-cluster
    repo: https://charts.releases.teleport.dev
    version: 18.1.2
    releaseName: teleport
    namespace: teleport
    valuesFile: helm-values.yaml
    includeCRDs: true

resources:
  - manifests/

patches:
  - target:
      kind: Deployment
      name: teleport-proxy
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: teleport-proxy
      spec:
        template:
          spec:
            hostNetwork: true
            dnsPolicy: ClusterFirstWithHostNet
  - target:
      kind: Service
      name: teleport
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: teleport
      spec:
        ports:
          - name: tls
            port: 443
            targetPort: 443
            protocol: TCP
