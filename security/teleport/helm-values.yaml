# Teleport Cluster Helm Values
# Chart: https://charts.releases.teleport.dev (teleport-cluster)
# Mode: Standalone with ACME certificates
#
# Note: App access is configured via teleport-kube-agent (separate ArgoCD Application)

# =============================================================================
# CLUSTER CONFIGURATION
# =============================================================================
clusterName: teleport.lumie-infra.com
chartMode: standalone

# =============================================================================
# IMAGE CONFIGURATION
# =============================================================================
# Using distroless image for security (bootstrap - external registry)
# Teleport needs to be accessible before Zot can be used
image: public.ecr.aws/gravitational/teleport-distroless

# =============================================================================
# AUTHENTICATION
# =============================================================================
authentication:
  type: local
  localAuth: true
  secondFactors:
    - webauthn
    - otp

# =============================================================================
# TLS CONFIGURATION - Using cert-manager instead of ACME
# =============================================================================
acme: false

# Use certificate from cert-manager
tls:
  existingSecretName: teleport-tls

# =============================================================================
# PERSISTENCE - Using PostgreSQL backend (infra-db)
# =============================================================================
persistence:
  enabled: false

# =============================================================================
# EXTRA ENVIRONMENT - DB credentials from Vault
# =============================================================================
extraEnv:
  - name: PGPASSWORD
    valueFrom:
      secretKeyRef:
        name: infra-db-credentials
        key: password

# =============================================================================
# POSTGRESQL BACKEND
# =============================================================================
auth:
  teleportConfig:
    teleport:
      storage:
        type: postgresql
        conn_string: "host=infra-db-rw.infra-db.svc.cluster.local port=5432 dbname=teleport user=bluemayne sslmode=disable"

# =============================================================================
# RESOURCES (VPA recommended, no CPU limit)
# =============================================================================
resources:
  requests:
    cpu: 100m
    memory: 1Gi
  limits:
    memory: 1Gi

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================
service:
  type: NodePort
  spec:
    ports:
      - name: tls
        port: 443
        targetPort: 3080
        nodePort: 31156
        protocol: TCP

# =============================================================================
# HIGH AVAILABILITY - Single replica for standalone
# =============================================================================
highAvailability:
  replicaCount: 1
  requireAntiAffinity: false

# =============================================================================
# PROXY CONFIGURATION
# =============================================================================
proxyListenerMode: multiplex

# Additional public addresses for internal cluster access
publicAddr:
  - teleport.lumie-infra.com:31156
  - teleport.teleport.svc.cluster.local:443

# =============================================================================
# OPERATOR - Enabled for managing Teleport CRDs (ProvisionTokens, etc.)
# =============================================================================
operator:
  enabled: true

# =============================================================================
# TOLERATIONS - Allow scheduling on control-plane nodes
# =============================================================================
tolerations:
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# =============================================================================
# AFFINITY - Prefer scheduling on worker nodes
# =============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: teleport-cluster
          topologyKey: kubernetes.io/hostname
