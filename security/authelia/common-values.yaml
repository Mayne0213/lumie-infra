# Common chart values for authelia

common:
  name: authelia

  # Disable deployment (external chart creates it)
  deployment:
    enabled: false

  service:
    enabled: false

  # Main authelia ingress
  ingress:
    enabled: true
    className: traefik
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: auth0213.kro.kr
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: authelia-tls
        hosts:
          - auth0213.kro.kr

  # Traefik Middleware for forwardAuth
  middleware:
    enabled: true
    name: authelia-auth
    forwardAuth:
      address: http://authelia.authelia.svc.cluster.local/api/authz/forward-auth
      trustForwardHeader: true
      authResponseHeaders:
        - Remote-User
        - Remote-Groups
        - Remote-Email
        - Remote-Name

  # ConfigMap for users database
  configMap:
    enabled: true
    name: authelia-config
    data:
      users_database.yml: |
        # Authelia Users Database
        # Generate password hash: docker run --rm authelia/authelia:latest authelia crypto hash generate argon2
        users:
          bluemayne:
            disabled: false
            displayname: "Bluemayne"
            email: "bluemayne0213@icloud.com"
            password: "$argon2id$v=19$m=65536,t=3,p=4$zrwIup8+ZsjtznkT05P7Vw$Y8Baat3CKXIGVaOemdLQRBuai1gv78Q12yCUd3yRf2U"
            groups:
              - admins

  # Vault Static Secrets (uses central vault/vault-auth)
  vaultStaticSecrets:
    # DB bootstrap secret (for CNPG)
    - name: authelia-db-bootstrap-static
      path: storage/postgresql
      destination:
        name: authelia-db-bootstrap
        transformation:
          templates:
            username: authelia
            password: "{{ .Secrets.POSTGRES_PASSWORD }}"
      rolloutRestartTargets:
        - kind: Deployment
          name: authelia

    # Authelia secrets (all from security/authelia path)
    - name: authelia-secrets-static
      path: security/authelia
      destination:
        name: authelia-secrets
        transformation:
          templates:
            storage.postgres.password.txt: "{{ .Secrets.AUTHELIA_POSTGRES_PASSWORD }}"
            session.encryption.key: "{{ .Secrets.AUTHELIA_SESSION_SECRET }}"
            storage.encryption.key: "{{ .Secrets.AUTHELIA_STORAGE_ENCRYPTION_KEY }}"
            identity_validation.reset_password.jwt.hmac.key: "{{ .Secrets.AUTHELIA_JWT_HMAC_KEY }}"
            identity_providers.oidc.hmac.key: "{{ .Secrets.AUTHELIA_OIDC_HMAC_SECRET }}"
            identity_providers.oidc.jwks.key: "{{ .Secrets.AUTHELIA_OIDC_JWKS_PRIVATE_KEY }}"
            HEADLAMP_CLIENT_SECRET: "{{ .Secrets.AUTHELIA_HEADLAMP_CLIENT_SECRET }}"
            VAULT_CLIENT_SECRET: "{{ .Secrets.AUTHELIA_VAULT_CLIENT_SECRET }}"
            ZOT_CLIENT_SECRET: "{{ .Secrets.AUTHELIA_ZOT_CLIENT_SECRET }}"
            GITEA_CLIENT_SECRET: "{{ .Secrets.AUTHELIA_GITEA_CLIENT_SECRET }}"
            FORGEJO_CLIENT_SECRET: "{{ .Secrets.AUTHELIA_FORGEJO_CLIENT_SECRET }}"
      rolloutRestartTargets:
        - kind: Deployment
          name: authelia

  # RBAC - ClusterRoleBinding for OIDC admin user
  rbac:
    enabled: true
    serviceAccount:
      create: false
    clusterRoleBindings:
      - name: oidc-admin-authelia
        roleRef:
          kind: ClusterRole
          name: cluster-admin
        subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: User
            name: bluemayne

  # CNPG Database configuration
  database:
    enabled: true
    instances: 2
    version: "16.6"
    name: authelia
    owner: authelia
    bootstrap:
      secret: authelia-db-bootstrap
    storage:
      class: local-path
      size: 1Gi
    resources:
      memory: 256Mi
      cpu: 50m
    backup:
      enabled: false
