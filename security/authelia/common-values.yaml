# Common chart values for authelia

common:
  name: authelia

  # Disable deployment (external chart creates it)
  deployment:
    enabled: false

  service:
    enabled: false

  # Main authelia ingress
  ingress:
    enabled: true
    className: traefik
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: auth0213.kro.kr
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: authelia-tls
        hosts:
          - auth0213.kro.kr

  # Traefik Middleware for forwardAuth
  middleware:
    enabled: true
    name: authelia-auth
    forwardAuth:
      address: http://authelia.authelia.svc.cluster.local/api/authz/forward-auth
      trustForwardHeader: true
      authResponseHeaders:
        - Remote-User
        - Remote-Groups
        - Remote-Email
        - Remote-Name

  # ConfigMap for users database
  configMap:
    enabled: true
    name: authelia-config
    data:
      users_database.yml: |
        # Authelia Users Database
        # Generate password hash: docker run --rm authelia/authelia:latest authelia crypto hash generate argon2
        users:
          bluemayne:
            disabled: false
            displayname: "Bluemayne"
            email: "bluemayne0213@icloud.com"
            password: "$argon2id$v=19$m=65536,t=3,p=4$zrwIup8+ZsjtznkT05P7Vw$Y8Baat3CKXIGVaOemdLQRBuai1gv78Q12yCUd3yRf2U"
            groups:
              - admins

  # External Secrets
  additionalExternalSecrets:
    # DB bootstrap secret
    - name: authelia-db-bootstrap
      refreshInterval: 1h
      secretStoreRef:
        name: vault-backend
        kind: ClusterSecretStore
      target:
        name: authelia-db-bootstrap
        creationPolicy: Owner
        template:
          data:
            username: authelia
            password: "{{ .password }}"
      data:
        - secretKey: password
          remoteRef:
            key: storage/postgresql
            property: POSTGRES_PASSWORD

    # Authelia secrets
    - name: authelia-secrets
      refreshInterval: 1h
      secretStoreRef:
        name: vault-backend
        kind: ClusterSecretStore
      target:
        name: authelia-secrets
        creationPolicy: Owner
      data:
        - secretKey: storage.postgres.password.txt
          remoteRef:
            key: storage/postgresql
            property: POSTGRES_PASSWORD
        - secretKey: session.encryption.key
          remoteRef:
            key: security/authelia
            property: AUTHELIA_SESSION_SECRET
        - secretKey: storage.encryption.key
          remoteRef:
            key: security/authelia
            property: AUTHELIA_STORAGE_ENCRYPTION_KEY
        - secretKey: identity_validation.reset_password.jwt.hmac.key
          remoteRef:
            key: security/authelia
            property: AUTHELIA_JWT_HMAC_KEY
        - secretKey: identity_providers.oidc.hmac.key
          remoteRef:
            key: security/authelia
            property: AUTHELIA_OIDC_HMAC_SECRET
        - secretKey: identity_providers.oidc.jwks.key
          remoteRef:
            key: security/authelia
            property: AUTHELIA_OIDC_JWKS_PRIVATE_KEY
        - secretKey: HEADLAMP_CLIENT_SECRET
          remoteRef:
            key: security/authelia
            property: AUTHELIA_HEADLAMP_CLIENT_SECRET
        - secretKey: VAULT_CLIENT_SECRET
          remoteRef:
            key: security/authelia
            property: AUTHELIA_VAULT_CLIENT_SECRET
        - secretKey: ZOT_CLIENT_SECRET
          remoteRef:
            key: security/authelia
            property: AUTHELIA_ZOT_CLIENT_SECRET
        - secretKey: GITEA_CLIENT_SECRET
          remoteRef:
            key: security/authelia
            property: AUTHELIA_GITEA_CLIENT_SECRET
        - secretKey: FORGEJO_CLIENT_SECRET
          remoteRef:
            key: security/authelia
            property: AUTHELIA_FORGEJO_CLIENT_SECRET

  # RBAC - ClusterRoleBinding for OIDC admin user
  rbac:
    enabled: true
    serviceAccount:
      create: false
    clusterRoleBindings:
      - name: oidc-admin-authelia
        roleRef:
          kind: ClusterRole
          name: cluster-admin
        subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: User
            name: bluemayne

  # CNPG Database configuration
  database:
    enabled: true
    instances: 2
    version: "16.6"
    name: authelia
    owner: authelia
    bootstrap:
      secret: authelia-db-bootstrap
    storage:
      class: local-path
      size: 1Gi
    resources:
      memory: 512Mi
      cpu: 50m
    backup:
      enabled: false
