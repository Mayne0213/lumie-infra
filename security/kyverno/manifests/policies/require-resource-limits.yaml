apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resource-limits
  annotations:
    policies.kyverno.io/title: Require Resource Limits
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Containers must have memory limits defined. CPU limits are not required
      as they can cause CPU throttling and stability issues. Memory limits
      prevent OOM situations from affecting the entire node.
spec:
  validationFailureAction: Audit
  background: true
  rules:
  - name: require-memory-limits
    match:
      any:
      - resources:
          kinds:
          - Pod
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - kyverno
    validate:
      message: "Memory limits are required for all containers."
      pattern:
        spec:
          containers:
          - resources:
              limits:
                memory: "?*"
  - name: require-memory-requests
    match:
      any:
      - resources:
          kinds:
          - Pod
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - kyverno
    validate:
      message: "Memory requests are required for all containers."
      pattern:
        spec:
          containers:
          - resources:
              requests:
                memory: "?*"
  - name: require-cpu-requests
    match:
      any:
      - resources:
          kinds:
          - Pod
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - kyverno
    validate:
      message: "CPU requests are required for all containers."
      pattern:
        spec:
          containers:
          - resources:
              requests:
                cpu: "?*"
