apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-zot-registry
  annotations:
    policies.kyverno.io/title: Require Zot Registry
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      All container images must be pulled from the internal Zot registry
      (zot0213.kro.kr) to ensure image provenance and security.
spec:
  validationFailureAction: Audit
  background: true
  rules:
  - name: validate-image-registry
    match:
      any:
      - resources:
          kinds:
          - Pod
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - argocd
          - cert-manager
          - external-secrets
          - gitea
          - haproxy
          - minio
          - vault
          - zot
          - kyverno
    validate:
      message: "Container images must be from zot0213.kro.kr registry."
      foreach:
      - list: "request.object.spec.containers"
        deny:
          conditions:
            all:
            - key: "{{element.image}}"
              operator: NotEquals
              value: "zot0213.kro.kr/*"
  - name: validate-init-container-registry
    match:
      any:
      - resources:
          kinds:
          - Pod
    exclude:
      any:
      - resources:
          namespaces:
          - kube-system
          - kube-public
          - kube-node-lease
          - argocd
          - cert-manager
          - external-secrets
          - gitea
          - haproxy
          - minio
          - vault
          - zot
          - kyverno
    preconditions:
      all:
      - key: "{{ request.object.spec.initContainers || `[]` | length(@) }}"
        operator: GreaterThanOrEquals
        value: 1
    validate:
      message: "Init container images must be from zot0213.kro.kr registry."
      foreach:
      - list: "request.object.spec.initContainers"
        deny:
          conditions:
            all:
            - key: "{{element.image}}"
              operator: NotEquals
              value: "zot0213.kro.kr/*"
