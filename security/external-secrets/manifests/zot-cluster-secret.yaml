apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: zot-registry-credentials
spec:
  externalSecretName: zot-registry-credentials
  namespaceSelector:
    matchLabels:
      zot-registry: enabled
  refreshTime: 1h
  externalSecretSpec:
    secretStoreRef:
      kind: ClusterSecretStore
      name: vault-backend
    target:
      name: zot-registry-credentials
      creationPolicy: Owner
      template:
        type: kubernetes.io/dockerconfigjson
        data:
          # Internal cluster address for Zot registry
          .dockerconfigjson: |
            {"auths":{"{{ .REGISTRY_URL }}":{"username":"{{ .USERNAME }}","password":"{{ .PASSWORD }}","auth":"{{ printf "%s:%s" .USERNAME .PASSWORD | b64enc }}"}}}
    data:
      - secretKey: REGISTRY_URL
        remoteRef:
          key: storage/zot
          property: REGISTRY_URL
      - secretKey: USERNAME
        remoteRef:
          key: storage/zot
          property: USERNAME
      - secretKey: PASSWORD
        remoteRef:
          key: storage/zot
          property: PASSWORD
