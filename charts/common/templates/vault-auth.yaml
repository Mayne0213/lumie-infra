{{- /* Local VaultAuth - only needed if not using central vault/vault-auth */ -}}
{{- if and .Values.common.vaultAuth .Values.common.vaultAuth.enabled }}
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultConnection
metadata:
  name: {{ .Values.common.vaultAuth.connectionName | default "vault-connection" }}
spec:
  address: {{ .Values.common.vaultAuth.address | default "http://vault.vault.svc.cluster.local:8200" }}
  skipTLSVerify: {{ .Values.common.vaultAuth.skipTLSVerify | default true }}
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: {{ .Values.common.vaultAuth.name | default "vault-auth" }}
spec:
  vaultConnectionRef: {{ .Values.common.vaultAuth.connectionName | default "vault-connection" }}
  method: {{ .Values.common.vaultAuth.method | default "kubernetes" }}
  mount: {{ .Values.common.vaultAuth.mount | default "kubernetes" }}
  kubernetes:
    role: {{ .Values.common.vaultAuth.role | default "vault-secrets-operator" }}
    serviceAccount: {{ .Values.common.vaultAuth.serviceAccount | default "default" }}
    audiences:
      {{- if .Values.common.vaultAuth.audiences }}
      {{- toYaml .Values.common.vaultAuth.audiences | nindent 6 }}
      {{- else }}
      - vault
      {{- end }}
{{- end }}
