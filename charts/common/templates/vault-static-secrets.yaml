{{/*
VaultStaticSecret template - supports both legacy and components format
*/}}

{{- if .Values.common.components }}
{{/* New components format - collect vaultStaticSecrets from all components */}}
{{- range $comp := .Values.common.components }}
{{- range $comp.vaultStaticSecrets }}
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ .name }}
spec:
  # Cross-namespace reference to vault/vault-auth (like ClusterSecretStore)
  vaultAuthRef: {{ .vaultAuthRef | default "vault/vault-auth" }}
  mount: {{ .mount | default "secret" }}
  type: {{ .type | default "kv-v2" }}
  path: {{ .path }}
  refreshAfter: {{ .refreshAfter | default "1h" }}
  destination:
    create: {{ .destination.create | default true }}
    name: {{ .destination.name | default .name }}
    {{- if .destination.type }}
    type: {{ .destination.type }}
    {{- end }}
    {{- if .destination.transformation }}
    transformation:
      excludeRaw: {{ .destination.transformation.excludeRaw | default true }}
      {{- if .destination.transformation.templates }}
      templates:
        {{- range $key, $value := .destination.transformation.templates }}
        {{ $key }}:
          text: {{ $value | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- if .rolloutRestartTargets }}
  rolloutRestartTargets:
    {{- range .rolloutRestartTargets }}
    - kind: {{ .kind }}
      name: {{ .name }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

{{- else }}
{{/* Legacy format */}}
{{- range .Values.common.vaultStaticSecrets }}
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ .name }}
spec:
  # Cross-namespace reference to vault/vault-auth (like ClusterSecretStore)
  vaultAuthRef: {{ .vaultAuthRef | default "vault/vault-auth" }}
  mount: {{ .mount | default "secret" }}
  type: {{ .type | default "kv-v2" }}
  path: {{ .path }}
  refreshAfter: {{ .refreshAfter | default "1h" }}
  destination:
    create: {{ .destination.create | default true }}
    name: {{ .destination.name | default .name }}
    {{- if .destination.type }}
    type: {{ .destination.type }}
    {{- end }}
    {{- if .destination.transformation }}
    transformation:
      excludeRaw: {{ .destination.transformation.excludeRaw | default true }}
      {{- if .destination.transformation.templates }}
      templates:
        {{- range $key, $value := .destination.transformation.templates }}
        {{ $key }}:
          text: {{ $value | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- if .rolloutRestartTargets }}
  rolloutRestartTargets:
    {{- range .rolloutRestartTargets }}
    - kind: {{ .kind }}
      name: {{ .name }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}
