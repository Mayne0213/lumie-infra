---
# K3s Master (Server) installation tasks

- name: Check if K3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Check K3s service status
  ansible.builtin.systemd:
    name: k3s
  register: k3s_service
  ignore_errors: true

- name: Get installed K3s version
  ansible.builtin.command: k3s --version
  register: k3s_installed_version
  changed_when: false
  failed_when: false
  when: k3s_binary.stat.exists

- name: Display K3s status
  ansible.builtin.debug:
    msg: >
      K3s installed: {{ k3s_binary.stat.exists }},
      Version: {{ k3s_installed_version.stdout | default('not installed') | regex_search('v[0-9.]+\\+k3s[0-9]+') }}

- name: Download K3s install script
  ansible.builtin.get_url:
    url: "{{ k3s_install_url }}"
    dest: /tmp/k3s-install.sh
    mode: '0755'
  when: not k3s_binary.stat.exists or k3s_version not in (k3s_installed_version.stdout | default(''))

- name: Install K3s server
  ansible.builtin.shell: |
    INSTALL_K3S_VERSION="{{ k3s_version }}" /tmp/k3s-install.sh server {{ k3s_server_args | join(' ') }}
  args:
    creates: /usr/local/bin/k3s
  register: k3s_install_result
  when: not k3s_binary.stat.exists

- name: Wait for K3s server to be ready
  ansible.builtin.wait_for:
    path: "{{ k3s_token_file }}"
    state: present
    timeout: 120

- name: Wait for K3s API to be available
  ansible.builtin.uri:
    url: "https://127.0.0.1:6443/healthz"
    validate_certs: false
    status_code: 200
  register: k3s_api
  retries: 30
  delay: 5
  until: k3s_api.status == 200

- name: Ensure K3s service is enabled and running
  ansible.builtin.systemd:
    name: k3s
    state: started
    enabled: yes
    daemon_reload: yes

- name: Read K3s node token
  ansible.builtin.slurp:
    src: "{{ k3s_token_file }}"
  register: k3s_token_content

- name: Set K3s token fact (for workers)
  ansible.builtin.set_fact:
    k3s_token: "{{ k3s_token_content.content | b64decode | trim }}"

- name: Display cluster join info
  ansible.builtin.debug:
    msg: |
      K3s Master is ready!
      API URL: {{ k3s_master_url }}
      Token file: {{ k3s_token_file }}

- name: Verify nodes are accessible
  ansible.builtin.command: kubectl get nodes
  register: kubectl_nodes
  changed_when: false
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"

- name: Display cluster nodes
  ansible.builtin.debug:
    var: kubectl_nodes.stdout_lines
