---
# MinIO block volume mount tasks
# Handles both fresh setup and re-provisioning (preserves existing data via LABEL)

- name: Check if block device exists
  ansible.builtin.stat:
    path: "{{ minio_block_device }}"
  register: block_device

- name: Fail if block device not found
  ansible.builtin.fail:
    msg: "Block device {{ minio_block_device }} not found. Ensure Terraform has attached the volume."
  when: not block_device.stat.exists

- name: Get block device filesystem info
  ansible.builtin.command: blkid -o value -s TYPE {{ minio_block_device }}
  register: block_fs_type
  changed_when: false
  failed_when: false

- name: Get block device label
  ansible.builtin.command: e2label {{ minio_block_device }}
  register: block_label
  changed_when: false
  failed_when: false

- name: Set expected label based on hostname
  ansible.builtin.set_fact:
    minio_expected_label: "minio-{{ inventory_hostname | replace('k3s-', '') }}"

- name: Format block device if not formatted
  community.general.filesystem:
    fstype: "{{ minio_filesystem }}"
    dev: "{{ minio_block_device }}"
  when: block_fs_type.stdout == ""

- name: Set filesystem label
  ansible.builtin.command: e2label {{ minio_block_device }} {{ minio_expected_label }}
  when: block_label.stdout != minio_expected_label
  changed_when: true

- name: Create mount point
  ansible.builtin.file:
    path: "{{ minio_mount_path }}"
    state: directory
    mode: '0755'

- name: Mount block volume by LABEL
  ansible.posix.mount:
    path: "{{ minio_mount_path }}"
    src: "LABEL={{ minio_expected_label }}"
    fstype: "{{ minio_filesystem }}"
    opts: defaults,nofail
    state: mounted

- name: Verify mount
  ansible.builtin.command: df -h {{ minio_mount_path }}
  register: mount_verify
  changed_when: false

- name: Display mount status
  ansible.builtin.debug:
    msg: "{{ mount_verify.stdout }}"
