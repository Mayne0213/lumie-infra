---
# Storage setup: Configure block volume for MinIO (whole disk, no partitioning)

- name: Check if block device exists
  ansible.builtin.stat:
    path: "{{ storage_block_device }}"
  register: block_device

- name: Fail if block device not found
  ansible.builtin.fail:
    msg: "Block device {{ storage_block_device }} not found."
  when: not block_device.stat.exists

- name: Set MinIO label
  ansible.builtin.set_fact:
    minio_label: "minio-{{ inventory_hostname | replace('k3s-', '') }}"

- name: Check current mount
  ansible.builtin.command: findmnt -n -o SOURCE {{ minio_mount_path }}
  register: current_mount
  changed_when: false
  failed_when: false

- name: Check disk label
  ansible.builtin.command: blkid -o value -s LABEL {{ storage_block_device }}
  register: disk_label
  changed_when: false
  failed_when: false

- name: Check disk filesystem
  ansible.builtin.command: blkid -o value -s TYPE {{ storage_block_device }}
  register: disk_fs
  changed_when: false
  failed_when: false

# Skip if already correctly mounted
- name: Storage already configured
  ansible.builtin.debug:
    msg: "Storage already mounted at {{ minio_mount_path }} with label {{ minio_label }}"
  when:
    - current_mount.rc == 0
    - disk_label.stdout == minio_label

# Format and mount if not already configured
- name: Configure storage
  when: current_mount.rc != 0 or disk_label.stdout != minio_label
  block:
    - name: Unmount if mounted elsewhere
      ansible.posix.mount:
        path: "{{ minio_mount_path }}"
        state: unmounted
      when: current_mount.rc == 0

    - name: Format disk
      community.general.filesystem:
        fstype: "{{ storage_filesystem }}"
        dev: "{{ storage_block_device }}"
      when: disk_fs.stdout != storage_filesystem

    - name: Set disk label
      ansible.builtin.command: e2label {{ storage_block_device }} {{ minio_label }}
      changed_when: true
      when: disk_label.stdout != minio_label

    - name: Create mount point
      ansible.builtin.file:
        path: "{{ minio_mount_path }}"
        state: directory
        mode: '0755'

    - name: Mount disk
      ansible.posix.mount:
        path: "{{ minio_mount_path }}"
        src: "LABEL={{ minio_label }}"
        fstype: "{{ storage_filesystem }}"
        opts: defaults,nofail
        state: mounted

- name: Verify mount
  ansible.builtin.command: df -h {{ minio_mount_path }}
  register: mount_verify
  changed_when: false

- name: Display mount status
  ansible.builtin.debug:
    msg: "{{ mount_verify.stdout }}"
