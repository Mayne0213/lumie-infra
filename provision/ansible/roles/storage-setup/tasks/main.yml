---
# Storage setup: Partition block volume for MinIO and Longhorn

- name: Check if block device exists
  ansible.builtin.stat:
    path: "{{ storage_block_device }}"
  register: block_device

- name: Fail if block device not found
  ansible.builtin.fail:
    msg: "Block device {{ storage_block_device }} not found."
  when: not block_device.stat.exists

- name: Check if already partitioned
  ansible.builtin.command: lsblk -no PTTYPE {{ storage_block_device }}
  register: partition_table
  changed_when: false
  failed_when: false

- name: Check if MinIO data exists
  ansible.builtin.stat:
    path: "{{ minio_mount_path }}"
  register: minio_data

# === Backup existing MinIO data if not partitioned ===
- name: Backup MinIO data (if migrating from raw disk)
  when: partition_table.stdout != "gpt" and minio_data.stat.exists
  block:
    - name: Create backup directory
      ansible.builtin.file:
        path: "{{ minio_backup_path }}"
        state: directory
        mode: '0755'

    - name: Sync MinIO data to backup
      ansible.builtin.command: rsync -av {{ minio_mount_path }}/ {{ minio_backup_path }}/
      changed_when: true

    - name: Unmount old MinIO volume
      ansible.posix.mount:
        path: "{{ minio_mount_path }}"
        state: unmounted

# === Partition the disk ===
- name: Create GPT partition table and partitions
  when: partition_table.stdout != "gpt"
  block:
    - name: Create GPT partition table
      ansible.builtin.command: parted -s {{ storage_block_device }} mklabel gpt
      changed_when: true

    - name: Create MinIO partition (50GB)
      ansible.builtin.command: parted -s {{ storage_block_device }} mkpart primary ext4 1MiB {{ minio_partition_size }}
      changed_when: true

    - name: Create Longhorn partition (remaining space)
      ansible.builtin.command: parted -s {{ storage_block_device }} mkpart primary ext4 {{ minio_partition_size }} 100%
      changed_when: true

    - name: Wait for partition devices
      ansible.builtin.wait_for:
        path: "{{ longhorn_partition }}"
        state: present
        timeout: 30

    - name: Update kernel partition table
      ansible.builtin.command: partprobe {{ storage_block_device }}
      changed_when: true

    - name: Wait for kernel to settle
      ansible.builtin.pause:
        seconds: 2

# === Format partitions ===
- name: Check MinIO partition filesystem
  ansible.builtin.command: blkid -o value -s TYPE {{ minio_partition }}
  register: minio_fs_type
  changed_when: false
  failed_when: false

- name: Format MinIO partition
  community.general.filesystem:
    fstype: "{{ storage_filesystem }}"
    dev: "{{ minio_partition }}"
  when: minio_fs_type.stdout == ""

- name: Check Longhorn partition filesystem
  ansible.builtin.command: blkid -o value -s TYPE {{ longhorn_partition }}
  register: longhorn_fs_type
  changed_when: false
  failed_when: false

- name: Format Longhorn partition
  community.general.filesystem:
    fstype: "{{ storage_filesystem }}"
    dev: "{{ longhorn_partition }}"
  when: longhorn_fs_type.stdout == ""

# === Set labels ===
- name: Set MinIO partition label
  ansible.builtin.set_fact:
    minio_label: "minio-{{ inventory_hostname | replace('k3s-', '') }}"
    longhorn_label: "longhorn-{{ inventory_hostname | replace('k3s-', '') }}"

- name: Apply MinIO label
  ansible.builtin.command: e2label {{ minio_partition }} {{ minio_label }}
  changed_when: true
  failed_when: false

- name: Apply Longhorn label
  ansible.builtin.command: e2label {{ longhorn_partition }} {{ longhorn_label }}
  changed_when: true
  failed_when: false

# === Mount partitions ===
- name: Create MinIO mount point
  ansible.builtin.file:
    path: "{{ minio_mount_path }}"
    state: directory
    mode: '0755'

- name: Create Longhorn mount point
  ansible.builtin.file:
    path: "{{ longhorn_mount_path }}"
    state: directory
    mode: '0755'

- name: Mount MinIO partition
  ansible.posix.mount:
    path: "{{ minio_mount_path }}"
    src: "LABEL={{ minio_label }}"
    fstype: "{{ storage_filesystem }}"
    opts: defaults,nofail
    state: mounted

- name: Mount Longhorn partition
  ansible.posix.mount:
    path: "{{ longhorn_mount_path }}"
    src: "LABEL={{ longhorn_label }}"
    fstype: "{{ storage_filesystem }}"
    opts: defaults,nofail
    state: mounted

# === Restore MinIO data ===
- name: Restore MinIO data from backup
  when: minio_backup_path is defined
  block:
    - name: Check if backup exists
      ansible.builtin.stat:
        path: "{{ minio_backup_path }}"
      register: backup_exists

    - name: Restore data from backup
      ansible.builtin.command: rsync -av {{ minio_backup_path }}/ {{ minio_mount_path }}/
      when: backup_exists.stat.exists
      changed_when: true

    - name: Remove backup after successful restore
      ansible.builtin.file:
        path: "{{ minio_backup_path }}"
        state: absent
      when: backup_exists.stat.exists

# === Verify ===
- name: Verify mounts
  ansible.builtin.command: df -h {{ minio_mount_path }} {{ longhorn_mount_path }}
  register: mount_verify
  changed_when: false

- name: Display mount status
  ansible.builtin.debug:
    msg: "{{ mount_verify.stdout }}"
