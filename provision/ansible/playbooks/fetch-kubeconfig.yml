---
# Fetch kubeconfig from master to local machine
# Usage: ansible-playbook -i inventory/terraform_inventory.py playbooks/fetch-kubeconfig.yml

- name: Fetch kubeconfig from master
  hosts: masters
  become: yes
  vars:
    local_kubeconfig_dir: "{{ playbook_dir }}/../kubeconfig"
  tasks:
    - name: Ensure local kubeconfig directory exists
      ansible.builtin.file:
        path: "{{ local_kubeconfig_dir }}"
        state: directory
        mode: '0700'
      delegate_to: localhost
      become: no

    - name: Read kubeconfig from master
      ansible.builtin.slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_raw

    - name: Decode kubeconfig
      ansible.builtin.set_fact:
        kubeconfig_content: "{{ kubeconfig_raw.content | b64decode }}"

    - name: Update server URL in kubeconfig (public IP)
      ansible.builtin.set_fact:
        kubeconfig_public: "{{ kubeconfig_content | regex_replace('https://127.0.0.1:6443', 'https://' + ansible_host + ':6443') }}"

    - name: Update server URL in kubeconfig (private IP)
      ansible.builtin.set_fact:
        kubeconfig_private: "{{ kubeconfig_content | regex_replace('https://127.0.0.1:6443', 'https://' + private_ip + ':6443') }}"

    - name: Save kubeconfig with public IP
      ansible.builtin.copy:
        content: "{{ kubeconfig_public }}"
        dest: "{{ local_kubeconfig_dir }}/k3s-public.yaml"
        mode: '0600'
      delegate_to: localhost
      become: no

    - name: Save kubeconfig with private IP
      ansible.builtin.copy:
        content: "{{ kubeconfig_private }}"
        dest: "{{ local_kubeconfig_dir }}/k3s-private.yaml"
        mode: '0600'
      delegate_to: localhost
      become: no

    - name: Create symlink to default kubeconfig
      ansible.builtin.file:
        src: "k3s-public.yaml"
        dest: "{{ local_kubeconfig_dir }}/config"
        state: link
      delegate_to: localhost
      become: no

    - name: Display kubeconfig info
      ansible.builtin.debug:
        msg: |
          Kubeconfig files saved to: {{ local_kubeconfig_dir }}

          Files created:
            - k3s-public.yaml  (uses public IP: {{ ansible_host }})
            - k3s-private.yaml (uses private IP: {{ private_ip }})
            - config           (symlink to k3s-public.yaml)

          Usage:
            export KUBECONFIG={{ local_kubeconfig_dir }}/config
            kubectl get nodes

          Or:
            kubectl --kubeconfig={{ local_kubeconfig_dir }}/k3s-public.yaml get nodes
      delegate_to: localhost
      become: no
